<html lang="zh-CN" data-theme="light" class="translated-ltr"><head><script data-astro-exec="">
			const url = window.location.href;
			const expectedUrl = url.replace(
				/^https:\/\/(?!beta)(\w+\.)?tradingview\.com/,
				'https://www.tradingview.com',
			);
			if (url !== expectedUrl) {
				window.location.replace(expectedUrl);
			}
		</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/pine-script-docs/static/favicon.ico"><link rel="icon" type="image/svg+xml" href="/pine-script-docs/favicon.svg"><title>写作/分析和优化</title><meta name="og:title" content="Writing / Profiling and optimization"><meta name="twitter:title" content="Writing / Profiling and optimization"><meta name="description" content="Everything you need to know about Pine Script™."><meta name="og:description" content="Everything you need to know about Pine Script™."><meta name="twitter:description" content="Everything you need to know about Pine Script™."><meta name="keywords" content="tradingview, pine, script, indicators, strategies"><meta name="og:image" content="/pine-script-docs/meta-image.png"><meta name="twitter:image" content="/pine-script-docs/meta-image.png"><meta name="og:image:width" content="1200"><meta name="og:image:height" content="630"><meta name="og:url" content="../../writing/profiling-and-optimization/"><meta name="twitter:url" content="../../writing/profiling-and-optimization/"><meta name="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@TradingView"><link rel="canonical" href="../../writing/profiling-and-optimization/"><link rel="sitemap" href="/pine-script-docs/sitemap-index.xml"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="none"><link rel="stylesheet" href="/pine-script-docs/_astro/index.jN9AZoBe.css">
<link rel="stylesheet" href="/pine-script-docs/_astro/index.C8b720yZ.css"><script type="module" src="/pine-script-docs/_astro/hoisted.D4iEV6y6.js" data-astro-exec=""></script><style type="text/css" media="screen">.monaco-editor-tv-pine-light { 
.mtk1 { color: #131722; }
.mtk2 { color: #ffffff; }
.mtk3 { color: #808080; }
.mtk4 { color: #ff0000; }
.mtk5 { color: #0451a5; }
.mtk6 { color: #0000ff; }
.mtk7 { color: #098658; }
.mtk8 { color: #008000; }
.mtk9 { color: #9598a1; }
.mtk10 { color: #dd0000; }
.mtk11 { color: #cc2929; }
.mtk12 { color: #f57f17; }
.mtk13 { color: #000000; }
.mtk14 { color: #383838; }
.mtk15 { color: #0c3299; }
.mtk16 { color: #2962ff; }
.mtk17 { color: #8e24aa; }
.mtk18 { color: #22ab94; }
.mtk19 { color: #cd3131; }
.mtk20 { color: #863b00; }
.mtk21 { color: #af00db; }
.mtk22 { color: #800000; }
.mtk23 { color: #e00000; }
.mtk24 { color: #3030c0; }
.mtk25 { color: #666666; }
.mtk26 { color: #778899; }
.mtk27 { color: #c700c7; }
.mtk28 { color: #a31515; }
.mtk29 { color: #388e3c; }
.mtk30 { color: #4f76ac; }
.mtk31 { color: #008080; }
.mtk32 { color: #001188; }
.mtk33 { color: #2a2e39; }
.mtk34 { color: #4864aa; }
.mtki { font-style: italic; }
.mtkb { font-weight: bold; }
.mtku { text-decoration: underline; text-underline-position: under; }
.mtks { text-decoration: line-through; }
.mtks.mtku { text-decoration: underline line-through; text-underline-position: under; } }</style><link type="text/css" rel="stylesheet" charset="UTF-8" href="https://www.gstatic.com/_/translate_http/_/ss/k=translate_http.tr.26tY-h6gH9w.L.W.O/am=GAY/d=0/rs=AN8SPfrev-A3NvrBP0gNq8zXCqKY7IcBLA/m=el_main_css"></head> <body> <div id="search-content-blur" hidden=""></div> <script data-astro-exec="">
	/* eslint-disable @typescript-eslint/typedef */
	window.ThemeProvider = (() => {
		function getCurrent() {
			return (
				// eslint-disable-next-line no-restricted-syntax
				typeof localStorage !== 'undefined' &&
				localStorage.getItem('tv-docs-theme')
			);
		}
		const storedTheme = getCurrent();
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ?
				'light'
			:	'dark');
		document.documentElement.dataset.theme =
			theme === 'light' ? 'light' : 'dark';
		document.documentElement.classList.toggle(
			'theme-dark',
			theme === 'dark',
		); // add support for ui-lib themes
		document.documentElement.classList.toggle(
			'sl-theme-dark',
			theme === 'dark',
		); // add support for shoelace themes

		return {
			updatePickers(themeArg = storedTheme || 'auto') {
				let currentTheme = themeArg;
				if (currentTheme === 'unknown') {
					currentTheme = getCurrent() || 'auto';
				}
				document
					.querySelectorAll('docs-theme-select')
					.forEach((picker) => {
						const select = picker.querySelector('select');
						if (select) select.value = currentTheme;
						/** @type {HTMLTemplateElement | null} */
						const tmpl = document.querySelector(`#theme-icons`);
						const newIcon =
							tmpl &&
							tmpl.content.querySelector('.' + currentTheme);
						if (newIcon) {
							const oldIcon =
								picker.querySelector('svg.label-icon');
							if (oldIcon) {
								oldIcon.replaceChildren(
									...newIcon.cloneNode(true).childNodes,
								);
							}
						}
					});
			},
		};
	})();
	/* eslint-enable @typescript-eslint/typedef */
</script><template id="theme-icons"><svg width="16px" height="16px" viewBox="0 0 28 28" class="light" data-icon="theme/sun-28">  <symbol id="ai:local:theme/sun-28"><g fill="currentColor"><path d="M14 3h1.5v5H14V3Zm0 18h1.5v5H14v-5Zm12-5.5V14h-5v1.5h5ZM8 14v1.5H3V14h5Zm15.3-7-1-1-3.6 3.6 1.1 1 3.5-3.5ZM9.5 18.7l1.1 1.1-3.5 3.5-1-1 3.4-3.6ZM22 23.3l1-1-3.6-3.6-1 1.1 3.5 3.5ZM10.3 9.6l-1.1 1-3.5-3.5 1-1 3.6 3.5Z"></path><path fill-rule="evenodd" d="M19 14.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Zm-1.5 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" clip-rule="evenodd"></path></g></symbol><use xlink:href="#ai:local:theme/sun-28"></use>  </svg><svg width="16px" height="16px" viewBox="0 0 28 28" class="dark" data-icon="theme/moon-28">  <symbol id="ai:local:theme/moon-28"><path fill="currentColor" fill-rule="evenodd" d="M21 7.02A9.23 9.23 0 0 0 15.2 5 9.1 9.1 0 0 0 6 14c0 4.97 4.12 9 9.2 9a9.33 9.33 0 0 0 5.8-2.02A7 7 0 0 1 14.36 14 7 7 0 0 1 21 7.02Zm-3.95-.3a7.91 7.91 0 0 0-1.85-.22A7.6 7.6 0 0 0 7.5 14a7.6 7.6 0 0 0 7.7 7.5 8 8 0 0 0 1.85-.22A8.46 8.46 0 0 1 12.86 14c0-3.1 1.69-5.8 4.19-7.28Z" clip-rule="evenodd"></path></symbol><use xlink:href="#ai:local:theme/moon-28"></use>  </svg><svg width="16px" height="16px" viewBox="0 0 28 28" class="auto" data-icon="theme/system-28">  <symbol id="ai:local:theme/system-28"><path fill="currentColor" d="M8 4h1v2H8V4Zm0 9v2h1v-2H8Zm6-3V9h-2v1h2ZM3 9v1h2V9H3Zm5.5 3a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Zm4.2-6-.7-.7-1.4 1.4.7.7L12.7 6ZM5 13.7l-.7-.7 1.4-1.4.7.7L5 13.7Zm7.7-.7-.7.7-1.4-1.4.7-.7 1.4 1.4ZM4.3 6l.7-.7 1.4 1.4-.7.7L4.3 6Zm3 17 14-14 .8.7L8 23.7l-.7-.7Zm17.2-.1a3.5 3.5 0 0 1-3.4-5.9H21a4 4 0 1 0 3.5 5.9Z"></path></symbol><use xlink:href="#ai:local:theme/system-28"></use>  </svg></template> <div class="backdrop" data-mobile-menu-backdrop="" data-astro-cid-h2irkosh=""></div> <div class="menu-container" data-astro-cid-h2irkosh=""> <div class="header" data-astro-cid-h2irkosh=""> <div class="header-group" data-astro-cid-h2irkosh="">    <docs-theme-select class="" data-astro-cid-3wpspbi7=""> <label style="--sl-select-width: 48px; --sl-label-icon-size: 28px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主题</font></font></span> <svg width="28" height="28" viewBox="0 0 28 28" class="icon label-icon" data-button="" data-round="" data-astro-cid-lmznfliq="" data-icon="theme/system-28">  <symbol id="ai:local:theme/sun-28"><g fill="currentColor"><path d="M14 3h1.5v5H14V3Zm0 18h1.5v5H14v-5Zm12-5.5V14h-5v1.5h5ZM8 14v1.5H3V14h5Zm15.3-7-1-1-3.6 3.6 1.1 1 3.5-3.5ZM9.5 18.7l1.1 1.1-3.5 3.5-1-1 3.4-3.6ZM22 23.3l1-1-3.6-3.6-1 1.1 3.5 3.5ZM10.3 9.6l-1.1 1-3.5-3.5 1-1 3.6 3.5Z"></path><path fill-rule="evenodd" d="M19 14.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Zm-1.5 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" clip-rule="evenodd"></path></g></symbol><use xlink:href="#ai:local:theme/sun-28"></use>  </svg> <select value="auto" data-button="" data-astro-cid-lmznfliq=""> <option value="dark" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;黑暗的&nbsp;&nbsp;</font></font></option><option value="light" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;明亮&nbsp;&nbsp;</font></font></option><option value="auto" selected="true" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;自动&nbsp;&nbsp;</font></font></option> </select>  </label>  </docs-theme-select>   <script data-astro-exec="">
	ThemeProvider.updatePickers('unknown');
</script>  </div> <div class="header-group" data-astro-cid-h2irkosh="">  <div class="not-content" style="stroke-width:2px" data-astro-cid-pkzv2hgs=""> <button id="mobile-menu-back-button" title="关闭菜单" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-gray stvb-medium stvb-primary stvb-icon">  <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-h2irkosh="" data-icon="theme/arrow-back">  <symbol id="ai:local:theme/arrow-back"><g fill="none"><g clip-path="url(#a)"><path stroke="var(--arrow-fill-color, #131722)" d="m17 20-6-6 6-6"></path></g><defs><clipPath id="a"><path fill="#fff" d="M28 28H0V0h28z"></path></clipPath></defs></g></symbol><use xlink:href="#ai:local:theme/arrow-back"></use>  </svg>  </button> </div>  </div> </div> <aside id="nav" class="keep-visible" style="--navbar-right-border-width: 0px" data-astro-cid-sa57sq6l=""> <div class="sidebar-viewport" data-astro-cid-sa57sq6l=""> <div class="sidebar" data-mobile="" data-astro-cid-sa57sq6l=""> <ul class="toc" aria-label="文档侧边栏" data-astro-cid-sa57sq6l=""> <li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/welcome" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">欢迎使用 Pine Script™ v5</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初识Pine Script™</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-steps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一步</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-indicator" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个指标</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/next-steps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语言</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/execution-model" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行模型</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/time-series" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间序列</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/script-structure" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本结构</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/identifiers" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份标识</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/operators" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/variable-declarations" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量声明</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/conditional-structures" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件结构</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/loops" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/type-system" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型系统</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/built-ins" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/user-defined-functions" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/objects" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/enums" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">枚举</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/methods" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/arrays" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/matrices" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">矩阵</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/maps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地图</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/alerts" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警报</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/backgrounds" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-coloring" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图色彩</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-plotting" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-states" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图状态</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/chart-information" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图表信息</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/colors" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/fills" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">填充</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/inputs" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输入</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/levels" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">级别</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/libraries" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/lines-and-boxes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">线条和盒子</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/non-standard-charts-data" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非标准图表数据</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/other-timeframes-and-data" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他时间范围和数据</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/plots" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/repainting" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新粉刷</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/sessions" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会议</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strategies" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">策略</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/tables" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/text-and-shapes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文本和形状</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/time" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/timeframes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间范围</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details open="" data-is-parent="" data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写脚本</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/style-guide" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">风格指南</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/debugging" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试</font></font></a></li><li class="item" data-current="" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/profiling-and-optimization" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和优化</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/publishing" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布脚本</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/limitations" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">限制</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常问问题</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/error-messages" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误消息</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/release-notes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行说明</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迁移指南</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-5" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 5</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-4" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 4</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-3" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 3</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/where-can-i-get-more-information" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在哪里可以获得更多信息？</font></font></a></li> </ul> <div class="toc-bottom" data-astro-cid-sa57sq6l=""></div> </div> </div> </aside>  </div>   <header class="header" data-astro-cid-d74r2unp=""> <nav role="navigation" aria-label="主导航" data-astro-cid-d74r2unp=""> <mobile-menu-button id="mobile-menu-button-wc" data-astro-cid-oojooh3d=""> <!-- Annoyingly I need to wrap this. TODO: improve this --> <div id="mobile-menu-button-header" data-astro-cid-oojooh3d=""> <div class="not-content" style="" data-astro-cid-pkzv2hgs=""> <button title="打开导航菜单" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-gray stvb-medium stvb-secondary stvb-icon stvb-icon-force-color stvb-force-no-border">  <svg width="28" height="28" viewBox="0 0 24 24" data-astro-cid-oojooh3d="" data-icon="theme/bars">  <symbol id="ai:local:theme/bars"><path fill="currentColor" d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"></path></symbol><use xlink:href="#ai:local:theme/bars"></use>  </svg>  </button> </div>  </div> </mobile-menu-button>   <div data-hide-when-search="" data-astro-cid-d74r2unp=""> <div class="header-logo" data-astro-cid-tycb33lk=""> <a href="/pine-script-docs/" aria-label="主页按钮" data-astro-cid-tycb33lk=""> <div class="documentation-logo logo" data-astro-cid-tycb33lk=""><svg width="188" height="44" viewBox="0 0 188 44" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M26.9989 28.0001L18.4281 20.7531L11.3382 23.2611C10.402 23.5923 9.60771 22.5041 10.2085 21.7134L21.0877 7.39502C21.4749 6.88536 22.2346 6.86567 22.6478 7.35459L34.7627 21.6923C35.1531 22.1543 35.0472 22.8544 34.5376 23.1802L26.9989 28.0001ZM32.4978 22.1105L27.1641 25.5207L19.7195 19.2258C19.1767 18.7669 18.4312 18.6305 17.7611 18.8676L13.8245 20.2602L21.9253 9.59841L32.4978 22.1105Z" fill="currentColor"></path>
<path d="M33.432 28.0842L38.3592 34.7471C38.7427 35.2657 38.3724 36 37.7274 36H6.27248C5.62746 36 5.25722 35.2657 5.64074 34.7471L10.8523 27.6996C10.9484 27.5697 11.0822 27.4725 11.2356 27.4214L17.6878 25.2707C17.9285 25.1904 18.1932 25.2314 18.3984 25.3806L26.2854 31.1166C26.5445 31.3051 26.8922 31.3173 27.1639 31.1475L32.3838 27.885C32.7316 27.6677 33.1881 27.7544 33.432 28.0842Z" fill="currentColor"></path>
<path d="M59.56 13.96C63.016 13.96 65.536 16.456 65.536 19.696C65.536 22.936 63.016 25.432 59.56 25.432H57.376V31H53.896V13.96H59.56ZM59.512 22.168C61.096 22.168 62.152 21.088 62.152 19.696C62.152 18.304 61.096 17.224 59.512 17.224H57.376V22.168H59.512ZM70.8636 14.944C70.8636 16.096 69.9276 17.032 68.7516 17.032C67.6236 17.032 66.6636 16.096 66.6636 14.944C66.6636 13.792 67.6236 12.856 68.7516 12.856C69.9276 12.856 70.8636 13.792 70.8636 14.944ZM67.1196 31V19H70.4076V31H67.1196ZM73.0849 31V19H76.3729V20.368C76.9969 19.408 78.2449 18.736 79.8049 18.736C82.7089 18.736 84.4369 20.848 84.4369 23.968V31H81.1489V24.52C81.1489 22.792 80.4049 21.736 79.0369 21.736C77.5249 21.736 76.3729 22.84 76.3729 25.144V31H73.0849ZM86.2041 25C86.2041 21.448 88.8681 18.736 92.5161 18.736C95.6601 18.736 98.4201 20.752 98.4201 24.64C98.4201 24.928 98.4201 25.264 98.3721 25.768H89.3961C89.5881 27.376 91.0041 28.264 92.5881 28.264C94.0761 28.264 95.1561 27.568 95.6841 26.752L98.1321 28.576C97.0281 30.184 95.0841 31.264 92.5641 31.264C88.9881 31.264 86.2041 28.792 86.2041 25ZM92.4201 21.448C91.1961 21.448 89.8281 22.072 89.5161 23.536H95.1321C94.8441 22.12 93.6441 21.448 92.4201 21.448ZM104.412 28.24L107.076 26.008C107.916 27.28 109.38 28.024 110.772 28.024C112.14 28.024 113.052 27.352 113.052 26.368C113.052 25.408 112.356 24.736 110.676 24.16L109.236 23.656C106.5 22.696 105.036 21.112 105.036 18.784C105.036 15.568 107.484 13.672 110.796 13.672C112.884 13.672 114.708 14.392 116.172 16.024L113.868 18.4C113.052 17.416 111.996 16.936 110.82 16.936C109.644 16.936 108.54 17.44 108.54 18.448C108.54 19.48 109.38 19.936 111.18 20.584L112.548 21.088C115.044 22 116.604 23.584 116.604 26.152C116.58 29.2 114.156 31.288 110.628 31.288C107.916 31.288 105.636 30.112 104.412 28.24ZM129.859 27.808C128.827 29.872 126.667 31.264 124.171 31.264C120.619 31.264 117.811 28.624 117.811 25C117.811 21.376 120.619 18.736 124.171 18.736C126.667 18.736 128.827 20.128 129.859 22.192L127.003 23.728C126.523 22.624 125.491 21.808 124.171 21.808C122.443 21.808 121.123 23.152 121.123 25C121.123 26.848 122.443 28.192 124.171 28.192C125.491 28.192 126.523 27.376 127.003 26.272L129.859 27.808ZM131.482 31V19H134.77V20.92C135.178 19.744 136.402 18.856 137.746 18.856C138.082 18.856 138.442 18.88 138.85 19V22.336C138.346 22.168 137.89 22.072 137.362 22.072C135.802 22.072 134.77 23.296 134.77 25.264V31H131.482ZM144.215 14.944C144.215 16.096 143.279 17.032 142.103 17.032C140.975 17.032 140.015 16.096 140.015 14.944C140.015 13.792 140.975 12.856 142.103 12.856C143.279 12.856 144.215 13.792 144.215 14.944ZM140.471 31V19H143.759V31H140.471ZM146.436 36.016V19H149.724V20.344C150.276 19.576 151.548 18.736 153.204 18.736C156.396 18.736 158.844 21.592 158.844 25C158.844 28.408 156.396 31.264 153.204 31.264C151.548 31.264 150.276 30.424 149.724 29.656V36.016H146.436ZM155.508 25C155.508 23.128 154.284 21.736 152.484 21.736C150.684 21.736 149.46 23.128 149.46 25C149.46 26.872 150.684 28.264 152.484 28.264C154.284 28.264 155.508 26.872 155.508 25ZM168.407 30.88C167.879 31.048 167.231 31.144 166.319 31.144C163.775 31.144 161.735 29.728 161.735 26.8V21.88H159.311V19H161.735V15.664H165.023V19H168.407V21.88H165.023V26.152C165.023 27.616 165.647 28.192 167.063 28.192C167.591 28.192 168.023 28.12 168.407 27.976V30.88ZM177.626 22.648V13.96H179.978L181.874 16.888L183.746 13.96H186.122V22.648H183.698V18.184L181.874 20.968L180.026 18.136V22.648H177.626ZM171.386 22.648V16.456H169.058V13.96H176.258V16.456H173.93V22.648H171.386Z" fill="currentColor"></path>
</svg>
</div> </a> </div>  </div> <div class="flex" data-astro-cid-d74r2unp=""></div> <div class="flex" data-astro-cid-d74r2unp=""> <div class="search-container" data-astro-cid-fg37foga=""> <div class="search-wrapper" data-astro-cid-fg37foga=""> <input class="search-input" type="text" placeholder="搜索文档" name="s" value="" data-astro-cid-fg37foga="" data-has-input-listener="true"> <svg width="28" height="28" viewBox="0 0 28 28" class="search-button" data-astro-cid-fg37foga="" data-icon="theme/search">  <symbol id="ai:local:theme/search"><path fill="currentColor" fill-rule="evenodd" d="M18.5 12.5a6 6 0 1 1-12 0 6 6 0 0 1 12 0Zm-1.25 5.8a7.5 7.5 0 1 1 1.06-1.06l4.22 4.23.53.53L22 23.06l-.53-.53-4.22-4.22Z" clip-rule="evenodd"></path></symbol><use xlink:href="#ai:local:theme/search"></use>  </svg> <button class="search-clear" type="button" title="重置" data-search-clear="" data-astro-cid-fg37foga=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">清除</font></font></button> <span class="divider" data-astro-cid-fg37foga=""></span> <button class="search-close" type="button" title="关闭" data-search-close="" data-astro-cid-fg37foga=""> <svg width="18" height="18" viewBox="0 0 18 18" data-astro-cid-fg37foga="" data-icon="theme/cross-18">  <use xlink:href="#ai:local:theme/cross-18"></use>  </svg> </button> </div> <div id="search-results-wrapper" data-astro-cid-fg37foga=""> <aside id="search-results" hidden="" data-astro-cid-fg37foga="" data-has-button-listener="true"> <!-- Don't use h1 because when built it will be used as the first heading on the page --> <div class="heading" data-astro-cid-fg37foga=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">搜索结果</font></font></div> <div id="search-results-contents" data-astro-cid-fg37foga=""></div> </aside> </div> </div>   </div> <ul class="links" data-astro-cid-d74r2unp="">  </ul> <div class="flex" data-astro-cid-d74r2unp=""></div> <div data-hide-when-search="" data-astro-cid-d74r2unp="">    </div> <button id="search-button" data-astro-cid-6zeqadij="" data-has-listener="true" style="display:none"> <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-6zeqadij="" data-icon="theme/search">  <use xlink:href="#ai:local:theme/search"></use>  </svg> </button>  <script data-base-url="/pine-script-docs" data-astro-exec="">
	async function loadPageFind() {
		const base = document.currentScript.getAttribute('data-base-url');
		const pageFindBundleUrl = `${base}/pagefind/`;
		const pagefind = await import(`${pageFindBundleUrl}pagefind.js`);
		await pagefind.options({
			bundlePath: pageFindBundleUrl,
		});
		window.pagefind = pagefind;
	}
	loadPageFind().catch();
</script>  <docs-theme-select class="hide-with-breakpoint-568" data-astro-cid-3wpspbi7=""> <label style="--sl-select-width: 48px; --sl-label-icon-size: 28px;" data-astro-cid-lmznfliq=""> <span class="sr-only" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主题</font></font></span> <svg width="28" height="28" viewBox="0 0 28 28" class="icon label-icon" data-button="" data-round="" data-astro-cid-lmznfliq="" data-icon="theme/system-28">  <symbol id="ai:local:theme/sun-28"><g fill="currentColor"><path d="M14 3h1.5v5H14V3Zm0 18h1.5v5H14v-5Zm12-5.5V14h-5v1.5h5ZM8 14v1.5H3V14h5Zm15.3-7-1-1-3.6 3.6 1.1 1 3.5-3.5ZM9.5 18.7l1.1 1.1-3.5 3.5-1-1 3.4-3.6ZM22 23.3l1-1-3.6-3.6-1 1.1 3.5 3.5ZM10.3 9.6l-1.1 1-3.5-3.5 1-1 3.6 3.5Z"></path><path fill-rule="evenodd" d="M19 14.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Zm-1.5 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" clip-rule="evenodd"></path></g></symbol><use xlink:href="#ai:local:theme/sun-28"></use>  </svg> <select value="auto" data-button="" data-astro-cid-lmznfliq=""> <option value="dark" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;黑暗的&nbsp;&nbsp;</font></font></option><option value="light" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;明亮&nbsp;&nbsp;</font></font></option><option value="auto" selected="true" data-astro-cid-lmznfliq=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;自动&nbsp;&nbsp;</font></font></option> </select>  </label>  </docs-theme-select>   <script data-astro-exec="">
	ThemeProvider.updatePickers('unknown');
</script>  </nav> </header>        <div id="image-lightbox" class="not-content" hidden="" data-astro-cid-kws7taxh=""> <div class="button-wrapper" data-astro-cid-kws7taxh=""> <div class="not-content" style="" data-astro-cid-pkzv2hgs=""> <button id="lightbox-close-button" title="关闭图片预览" data-astro-cid-pkzv2hgs="" class="not-content stvb-base stvb-pointer stvb-black stvb-medium stvb-secondary stvb-icon stvb-force-no-border">  <svg width="24" height="24" viewBox="0 0 18 18" data-astro-cid-kws7taxh="" data-icon="theme/cross-18">  <symbol id="ai:local:theme/cross-18"><g fill="none"><g clip-path="url(#a)"><path fill="currentColor" fill-rule="evenodd" d="M5.53 4.47 4.47 5.53 7.94 9l-3.47 3.47 1.06 1.06L9 10.06l3.47 3.47 1.06-1.06L10.06 9l3.47-3.47-1.06-1.06L9 7.94 5.53 4.47Z" clip-rule="evenodd"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h18v18H0z"></path></clipPath></defs></g></symbol><use xlink:href="#ai:local:theme/cross-18"></use>  </svg>  </button> </div>  </div> <img id="lightbox-image" src="" data-astro-cid-kws7taxh=""> </div>   <div id="page-container" data-astro-cid-xgirumru=""> <aside id="nav" class="" style="" data-astro-cid-sa57sq6l=""> <div class="sidebar-viewport" data-astro-cid-sa57sq6l=""> <div class="sidebar" data-astro-cid-sa57sq6l=""> <ul class="toc" aria-label="文档侧边栏" data-astro-cid-sa57sq6l=""> <li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/welcome" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">欢迎使用 Pine Script™ v5</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初识Pine Script™</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <symbol id="ai:local:theme/right-caret"><path fill="currentColor" d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"></path></symbol><use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-steps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一步</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/first-indicator" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个指标</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/primer/next-steps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语言</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/execution-model" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行模型</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/time-series" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间序列</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/script-structure" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本结构</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/identifiers" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份标识</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/operators" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/variable-declarations" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量声明</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/conditional-structures" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件结构</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/loops" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/type-system" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型系统</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/built-ins" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/user-defined-functions" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/objects" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/enums" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">枚举</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/methods" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/arrays" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/matrices" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">矩阵</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/language/maps" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地图</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/alerts" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警报</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/backgrounds" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-coloring" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图色彩</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-plotting" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/bar-states" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图状态</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/chart-information" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图表信息</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/colors" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/fills" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">填充</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/inputs" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输入</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/levels" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">级别</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/libraries" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/lines-and-boxes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">线条和盒子</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/non-standard-charts-data" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非标准图表数据</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/other-timeframes-and-data" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他时间范围和数据</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/plots" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/repainting" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新粉刷</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/sessions" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会议</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/strategies" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">策略</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/tables" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/text-and-shapes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文本和形状</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/time" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/concepts/timeframes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间范围</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><details open="" data-is-parent="" data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写脚本</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/style-guide" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">风格指南</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/debugging" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试</font></font></a></li><li class="item" data-current="" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/profiling-and-optimization" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和优化</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/publishing" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布脚本</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/writing/limitations" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">限制</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/faq" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常问问题</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/error-messages" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误消息</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/release-notes" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行说明</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><details data-astro-cid-omxx3dey=""><summary data-astro-cid-omxx3dey=""><div class="summary-link" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迁移指南</font></font></div><div class="caret" data-astro-cid-omxx3dey=""><svg width="18" height="18" viewBox="0 0 24 24" class="icon" data-astro-cid-omxx3dey="" data-icon="theme/right-caret">  <use xlink:href="#ai:local:theme/right-caret"></use>  </svg></div></summary><ul class="children" data-astro-cid-omxx3dey=""><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-5" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 5</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-4" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 4</font></font></a></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/migration-guides/to-pine-version-3" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转至 Pine Script™ 版本 3</font></font></a></li></ul></details></li><li class="item" data-astro-cid-omxx3dey=""><a class="page-link" href="/pine-script-docs/where-can-i-get-more-information" data-astro-cid-omxx3dey=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在哪里可以获得更多信息？</font></font></a></li> </ul> <div class="toc-bottom" data-astro-cid-sa57sq6l=""></div> </div> </div> </aside>  <main class="main-pane" data-page-type="md" data-astro-cid-xgirumru=""> <a id="top" data-astro-cid-xgirumru=""></a> <main class="content" data-toc-shown="" data-astro-cid-ju3wuhkz="">  <div class="content-width" data-astro-cid-xgirumru=""> <div class="breadcrumbs" data-pagefind-ignore="" data-astro-cid-wlavna2o=""> <a href="/pine-script-docs" aria-label="返回文档主页。" data-astro-cid-wlavna2o=""> <span data-astro-cid-wlavna2o=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户手册</font></font></span>  </a>  <span class="divider" data-astro-cid-wlavna2o=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/</font></font></span> <a href="/pine-script-docs/writing/style-guide" data-astro-cid-wlavna2o=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写脚本</font></font></a> <span class="divider" data-astro-cid-wlavna2o=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/</font></font></span> <span class="current-item" data-astro-cid-wlavna2o=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和优化</font></font></span> </div>     </div> <div id="slot-container" data-astro-cid-xgirumru="">  <h1 id="profiling-and-optimization" class="md-heading"><a href="#profiling-and-optimization"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h1>
<h2 id="introduction" class="md-heading"><a href="#introduction"> <span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 是一种基于云的编译语言，旨在高效地重复执行脚本。当用户将 Pine 脚本添加到图表时，它会执行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次，每次执行一次访问数据源中可用的条形图或刻度线，如本手册的</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/execution-model"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行模型</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">页面中所述
</font><font style="vertical-align: inherit;">
。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 编译器会自动执行多项内部优化，以适应各种大小的脚本并帮助它们顺利运行。但是，此类优化</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">避免脚本执行中的性能瓶颈。因此，程序员需要
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本的运行时性能，并在需要缩短执行时间时找出修改关键代码块和行的方法。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本页介绍如何使用
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Profiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和监控脚本的运行时和执行情况，并解释了程序员可以修改其代码以
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#optimization"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行时性能的一些方法。</font></font></p>
<h2 id="pine-profiler" class="md-heading"><a href="#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">松木</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">剖面仪</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在深入
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#optimization"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前，明智的做法是评估脚本的运行时间并找出
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">瓶颈</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，即代码中对整体性能有重大影响的区域。有了这些见解，程序员可以确保专注于优化真正重要的地方，而不是花时间和精力在影响较小的代码上。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输入</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Profiler</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是一个功能强大的实用程序，可分析脚本中所有重要代码行和块的执行情况，并在 Pine Editor 中的行旁边显示有用的性能信息。通过检查 Profiler 的结果，程序员可以更清楚地了解脚本的整体运行时间、运行时间在其重要代码区域中的分布以及可能需要额外关注和优化的关键部分。</font></font></p>
<h3 id="profiling-a-script" class="md-heading"><a href="#profiling-a-script"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Profiler 可以分析用 Pine Script™ v5 编写的任何</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可编辑</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
脚本的运行时性能。要分析脚本，请将其添加到图表中，在 Pine Editor 中打开源代码，然后从右上角“添加到图表/在图表上更新”选项旁边的下拉菜单中选择“启用分析器模式”：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-1.Bm1SQAOz_ZcitjV.webp" alt="图像" width="666" height="286" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将使用下面的脚本作为我们的初始分析示例，该脚本</font></font><code dir="auto">oscillator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收盘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">价与条形图
上百分位数</font><font style="vertical-align: inherit;">
和下
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.percentile_linear_interpolation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">百分位数</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的平均距离计算自定义值。它包括几种不同类型的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要代码区域，在分析时，这些代码区域的</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解释</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会有所不同
</font><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="6yg"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Pine&nbsp;Profiler&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculations.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;percentage&nbsp;for&nbsp;upper&nbsp;percentile&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">75.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Upper&nbsp;percentile"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;percentage&nbsp;for&nbsp;lower&nbsp;percentile&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">25.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Lower&nbsp;percentile"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;percentiles&nbsp;using&nbsp;the&nbsp;linear&nbsp;interpol</span><span class="mtk9">ation&nbsp;method.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Declare&nbsp;arrays&nbsp;for&nbsp;upper&nbsp;and&nbsp;lower&nbsp;deviations&nbsp;f</span><span class="mtk9">rom&nbsp;the&nbsp;percentiles&nbsp;on&nbsp;the&nbsp;same&nbsp;line.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;distance&nbsp;values&nbsp;through&nbsp;the&nbsp;`upperDistanc</span><span class="mtk9">es`&nbsp;and&nbsp;`lowerDistances`&nbsp;arrays&nbsp;based&nbsp;on&nbsp;excessive</span><span class="mtk9">&nbsp;price&nbsp;deviations.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;average&nbsp;distance&nbsp;from&nbsp;the&nbsp;`upperDistances`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;average&nbsp;distance&nbsp;from&nbsp;the&nbsp;`lowerDistances`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;`upperAvg</span><span class="mtk9">`&nbsp;and&nbsp;`lowerAvg`&nbsp;to&nbsp;their&nbsp;sum.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperAvg</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerAvg</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;color&nbsp;of&nbsp;the&nbsp;plot.&nbsp;A&nbsp;green-based&nbsp;gradient&nbsp;if&nbsp;</span><span class="mtk9">`oscillator`&nbsp;is&nbsp;positive,&nbsp;a&nbsp;red-based&nbsp;gradient&nbsp;oth</span><span class="mtk9">erwise.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">-1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;with&nbsp;the&nbsp;`oscColor`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一旦启用，Profiler 会从脚本的重要代码行和块的所有执行中收集信息，然后在 Pine 编辑器内的代码行左侧显示条形图和大致的运行时间百分比：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-2.Ud_wxirg_1toi2O.webp" alt="图像" width="1342" height="670" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 跟踪重要代码区域的每次执行，包括</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实时</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行。其信息会随着新执行的发生而不断更新。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于脚本声明语句、类型声明和其他</font><em><font style="vertical-align: inherit;">无关紧要的</font></em><font style="vertical-align: inherit;">代码行（例如没有实际影响的变量声明、</font><font style="vertical-align: inherit;">脚本输出不依赖的
</font><em><font style="vertical-align: inherit;">未使用代码</font></em><font style="vertical-align: inherit;">或编译器在翻译过程中优化的
</font><em><font style="vertical-align: inherit;">重复代码）</font></em><font style="vertical-align: inherit;"> ，分析器结果</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会显示。请参阅</font></font></strong><font style="vertical-align: inherit;"><a href="/pine-script-docs/writing/profiling-and-optimization#insignificant-unused-and-redundant-code"><font style="vertical-align: inherit;">本节</font></a><font style="vertical-align: inherit;">了解更多信息。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#insignificant-unused-and-redundant-code"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本包含至少</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">四行</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要代码时，Profiler 将在性能影响最大的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前三个</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码区域旁边显示“火焰”图标。如果一个或多个影响最大的代码区域超出了</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Editor 中可见的行数，则左边距的顶部或底部将显示一个“火焰”图标和一个数字，表示有多少关键行超出了视图。单击图标将垂直滚动编辑器窗口以显示最近的关键行：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-3.CRdP8jVv_Z2lC0Am.webp" alt="图像" width="1342" height="346" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将鼠标指针悬停在行旁边的空间上会突出显示已分析的代码，并显示包含其他信息的工具提示，包括所花费的时间和执行次数。每行旁边和相应工具提示中显示的信息取决于所分析的代码区域。以下
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部分</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍了 Profiler 分析的不同类型的代码以及如何解释它们的性能结果。</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-a-script-4.B8hBGa6N_2sbc0.webp" alt="图像" width="1342" height="588" loading="lazy" decoding="async"></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与其他语言的分析工具一样，Pine Profiler会将</font><font style="vertical-align: inherit;">脚本及其重要代码与
收集性能数据所需的</font><a href="/pine-script-docs/writing/profiling-and-optimization#alook-into-the-profilers-inner-workings"><font style="vertical-align: inherit;">额外计算</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结合起来</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，脚本的资源使用量在分析时</font><strong><font style="vertical-align: inherit;">会增加</font></strong><font style="vertical-align: inherit;">，而 Profiler 的结果会反映包含这些计算的脚本运行时间。因此，应将结果解释为</font><strong><font style="vertical-align: inherit;">估计值</font></strong><font style="vertical-align: inherit;">，而不是精确的性能测量值。</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#alook-into-the-profilers-inner-workings"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此外，Profiler 无法收集和显示影响运行时间的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部计算</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的单独性能数据，包括跟踪性能所需的计算，这意味着脚本所有代码区域显示的时间值加起来</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正好等于其总运行时间的 100%。</font></font></p><p></p></div></aside>
<h3 id="interpreting-profiled-results" class="md-heading"><a href="#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解释分析</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<h4 id="single-line-results" class="md-heading"><a href="#single-line-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单行</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于包含单行表达式的代码行，Profiler 栏和显示的百分比表示脚本在该行上花费的总运行时间的相对比例。相应的工具提示显示三个字段：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“行号”字段表示分析的代码行。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“时间”字段显示代码行的运行时间百分比、该行所花费的运行时间以及脚本的总运行时间。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“执行”字段显示运行脚本时特定行执行的次数。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我们将指针悬停在所分析代码的第 12 行旁边的空间上，以查看其工具提示：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-1.DxmafMJF_Z1xuVkr.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="pa"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_linear_interpolation</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentInput</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该行的时间信息代表完成所有</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行所花费的时间</font><font style="vertical-align: inherit;">，</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单次执行所花费的时间。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要估算每次执行的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平均</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间，请将行的时间除以执行次数。在本例中，工具提示显示第 12 行执行 20,685 次花费了大约 14.1 毫秒，这意味着每次执行的平均时间约为 14.1 毫秒/20685 = 0.0006816534 毫秒（0.6816534 微秒）。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当一行代码由多个用逗号分隔的表达式组成时，工具提示中显示的执行次数表示
每个表达式的总执行次数的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总和</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，显示的时间值表示评估该行所有表达式所花费的总时间。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，我们初始示例中的这个全局行包含两个
</font><font style="vertical-align: inherit;">用逗号分隔的
</font></font><a href="/pine-script-docs/language/variable-declarations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量声明。每个都使用</font></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_var"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关键字，这意味着脚本仅在第一个可用条上执行一次。正如我们在该行的 Profiler 工具提示中看到的那样，它计算了</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行（每个表达式一次），显示的时间值是该行上两个表达式的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组合</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-2.CGsjIphG_1lBWSK.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="6hn"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerDistances</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">lengthInput</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当分析同一行上有多个表达式的脚本时，我们建议将每个表达式移动到</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单独的行</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，以便在分析时获得更详细的见解，即如果它们可能包含</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响更大的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当为了可读性或风格目的而使用
</font></font><a href="/pine-script-docs/writing/style-guide#line-wrapping"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">换行时</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，Profiler 会将换行的所有部分视为</font><font style="vertical-align: inherit;">
Pine 编辑器中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一行的一部分。</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，尽管我们初始脚本中的这段代码在 Pine 编辑器中占据了多行，但它仍被视为一行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且 Profiler 工具提示会显示单行结果，其中“行号”字段显示换行所在的编辑器中的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Single-line-results-3.8u0gLHs0_yR0hQ.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="6dv"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">-1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.gray</span><span class="mtk13">)</span></span><br></code></div>
<h4 id="code-block-results" class="md-heading"><a href="#code-block-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码块</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/language/conditional-structures"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件结构</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开头的一行</font><font style="vertical-align: inherit;">，Profiler 栏和百分比表示脚本运行时间在</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整个代码块</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（而不仅仅是单行）上所占的相对比例。相应的工具提示显示四个字段：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“代码块范围”字段表示该结构包含的行范围。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“时间”字段显示代码块的运行时间百分比、所有块执行所花费的时间以及脚本的总运行时间。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“行时间”字段显示块的初始行的运行时间百分比、在该行上花费的时间以及脚本的总运行时间。对于
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
块或
</font><em><font style="vertical-align: inherit;">带有</font></em><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">else if语句的</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
块，其解释有所不同，因为这些值表示在</font><strong><font style="vertical-align: inherit;">所有</font></strong><font style="vertical-align: inherit;">
结构的条件语句</font><font style="vertical-align: inherit;">
上花费的总时间。有关更多信息，请参阅下文。</font></font><em><font style="vertical-align: inherit;"></font></em> <a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“执行”字段显示运行脚本时代码块执行的次数。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我们将鼠标悬停在初始脚本中第 19 行旁边的空间上，这是一个简单的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构的开头</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，没有</font></font></em> <a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
语句。如下所示，工具提示显示了整个代码块和当前行的性能信息：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-1.Cp7Cs5Lf_Z1aX7Bw.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="1n6"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerPercentile</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperPercentile</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">upperDistances</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">lowerPercentile</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">lowerDistances</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“时间”字段显示，对该结构进行 20,685 次求值总共花费了 7.2 毫秒。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“行时间”字段表示
</font><font style="vertical-align: inherit;">此
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if结构</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一行</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所花费的运行时间
约为三毫秒。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户还可以检查代码块范围内的行和嵌套块的结果，以获得更细致的性能洞察。在这里，我们将鼠标悬停在代码块内第 20 行旁边的空间上，以查看其
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#single-line-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单行结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-2.Cy1_m4AY_ZsCh1h.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示的执行次数</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小于</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整个代码块的结果，因为控制此行执行的条件并非始终返回。</font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;">循环</font></a></font><code dir="auto">true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内的代码则相反，</font><font style="vertical-align: inherit;">因为每次执行循环语句都会触发
</font><strong><font style="vertical-align: inherit;">多次</font></strong><font style="vertical-align: inherit;">执行循环的局部块。</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在分析
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构或
</font><font style="vertical-align: inherit;">
包含</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">else if语句的</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构时
，“行时间”字段将显示执行
</font><font style="vertical-align: inherit;">结构的</font><strong><font style="vertical-align: inherit;">所有条件表达式（</font></strong><strong><font style="vertical-align: inherit;">而不仅仅是</font></strong><font style="vertical-align: inherit;">块的第一行）所花费的时间。代码块范围内的行的结果将显示每个</font><strong><font style="vertical-align: inherit;">本地块</font></strong><font style="vertical-align: inherit;">的运行时间和执行情况。由于 Profiler 的计算和显示限制，这种格式对于这些结构是必需的。
</font><font style="vertical-align: inherit;">有关更多信息，请参阅</font><a href="/pine-script-docs/writing/profiling-and-optimization#alook-into-the-profilers-inner-workings"><font style="vertical-align: inherit;">本节。</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#alook-into-the-profilers-inner-workings"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，
此脚本中</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch结构的“行时间”表示评估其主体内</font></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有四个</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件语句
所花费的时间</font><font style="vertical-align: inherit;">
，因为 Profiler</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单独跟踪它们。代码块范围内每行的结果代表每个</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本地块</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的性能信息：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-3.D12wyQyn_ZXHSFp.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="1sk"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"`switch`&nbsp;and&nbsp;`if...else&nbsp;if`&nbsp;results&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;upper&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;lower&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;`upperBand`&nbsp;and&nbsp;`lowerBand`&nbsp;based&nbsp;on</span><span class="mtk9">&nbsp;the&nbsp;proximity&nbsp;of&nbsp;the&nbsp;`close`&nbsp;to&nbsp;the&nbsp;current&nbsp;band&nbsp;</span><span class="mtk9">values.</span></span><br><span><span class="mtk9">//&nbsp;The&nbsp;"Line&nbsp;time"&nbsp;field&nbsp;on&nbsp;line&nbsp;11&nbsp;represents&nbsp;the</span><span class="mtk9">&nbsp;time&nbsp;spent&nbsp;on&nbsp;all&nbsp;4&nbsp;conditional&nbsp;expressions&nbsp;in&nbsp;th</span><span class="mtk9">e&nbsp;structure.</span></span><br><span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;`close`&nbsp;and&nbsp;`</span><span class="mtk9">lowerBand`&nbsp;to&nbsp;the&nbsp;band&nbsp;range.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;as&nbsp;columns&nbsp;with&nbsp;a&nbsp;dynamic</span><span class="mtk9">&nbsp;color.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_columns</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">histbase</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当此类结构中的条件逻辑涉及大量计算时，程序员可能需要针对每个计算条件提供更详细的性能信息。实现此分析的有效方法是使用</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嵌套</font></font></em>
<a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块，而不是更紧凑的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
或</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if…else if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构。例如，而不是：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3eu"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="1ht"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以使用嵌套的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块进行更深入的分析，同时保持相同的逻辑流程：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3o9"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock1</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">expression2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock2</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk33">localBlock3</span><span class="mtk18">&gt;</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下面，我们将前面的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
示例更改为等效的嵌套
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构。现在，我们可以分别查看条件模式每个重要部分的运行时和执行情况：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Code-block-results-4.OxkZ6XRw_Zs1azS.webp" alt="图像" width="1072" height="338" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="5rt"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"`switch`&nbsp;and&nbsp;`if...else&nbsp;if`&nbsp;results&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;upper&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;lower&nbsp;band&nbsp;for&nbsp;oscillator&nbsp;calculation.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;`upperBand`&nbsp;and&nbsp;`lowerBand`&nbsp;based&nbsp;on</span><span class="mtk9">&nbsp;the&nbsp;proximity&nbsp;of&nbsp;the&nbsp;`close`&nbsp;to&nbsp;the&nbsp;current&nbsp;band&nbsp;</span><span class="mtk9">values.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;ratio&nbsp;of&nbsp;the&nbsp;difference&nbsp;between&nbsp;`close`&nbsp;and&nbsp;`</span><span class="mtk9">lowerBand`&nbsp;to&nbsp;the&nbsp;band&nbsp;range.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">upperBand</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowerBand</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`oscillator`&nbsp;as&nbsp;columns&nbsp;with&nbsp;a&nbsp;dynamic</span><span class="mtk9">&nbsp;color.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Oscillator"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">oscillator</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">?</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk1">&nbsp;</span><span class="mtk18">:</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_columns</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">histbase</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50.0</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同样的流程也适用于</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#op_?:"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三元表达式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。当复杂的三元表达式的操作数包含重要计算时，将逻辑重新组织为嵌套的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构可以获得更详细的 Profiler 结果，从而更容易发现关键部分。</font></font></li>
</ul>
<h4 id="user-defined-function-calls" class="md-heading"><a href="#user-defined-function-calls"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是由用户编写的函数。它们封装了脚本可能多次执行的代码序列。用户经常编写函数和方法以提高代码的模块化、可重用性和可维护性。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数内缩进的代码行表示其</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">局部作用域</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，即每次脚本调用时</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的序列。与脚本全局作用域中的代码（脚本每次执行时都会评估一次）不同，函数内的代码在每次脚本执行时可能会激活零次、一次或</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，具体取决于触发调用的条件、发生的调用次数以及函数的逻辑。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在解释 Profiler 结果时，考虑这一区别至关重要。当分析的代码包含
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义的函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用时：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个函数调用</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的结果</font><font style="vertical-align: inherit;">反映了分配给它的运行时间以及脚本激活该特定调用的总次数。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数范围</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有本地代码的时间和执行信息反映了</font><font style="vertical-align: inherit;">对该函数的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有调用的综合结果。</font></font></strong><font style="vertical-align: inherit;"></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此示例包含一个用户定义</font></font><code dir="auto">similarity()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，用于估算两个系列的相似度，脚本每次执行时仅从全局范围调用
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该函数。在本例中，Profiler 对函数主体内代码的结果与该特定调用相对应：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-User-defined-function-calls-1.DUf4uWCa_1zRHzX.webp" alt="图像" width="1072" height="328" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="7jp"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;function&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Estimates&nbsp;the&nbsp;similarity&nbsp;between&nbsp;two&nbsp;standardized</span><span class="mtk9">&nbsp;series&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each&nbsp;individual&nbsp;call&nbsp;to&nbsp;this&nbsp;function&nbsp;</span><span class="mtk9">activates&nbsp;its&nbsp;local&nbsp;scope.</span></span><br><span><span class="mtk15">similarity</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Standardize&nbsp;`sourceA`&nbsp;and&nbsp;`sourceB`&nbsp;for&nbsp;compari</span><span class="mtk9">son.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;and&nbsp;return&nbsp;the&nbsp;estimated&nbsp;similarity&nbsp;o</span><span class="mtk9">f&nbsp;`normA`&nbsp;and&nbsp;`normB`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;similarity&nbsp;between&nbsp;the&nbsp;`close`&nbsp;and&nbsp;an&nbsp;</span><span class="mtk9">offset&nbsp;`close`&nbsp;series.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们增加脚本每次执行时调用该函数的次数。在这里，我们将脚本更改为调用用户
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义函数</font></font></a> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">五次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="6p1"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;function&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Estimates&nbsp;the&nbsp;similarity&nbsp;between&nbsp;two&nbsp;standardized</span><span class="mtk9">&nbsp;series&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Each&nbsp;individual&nbsp;call&nbsp;to&nbsp;this&nbsp;function&nbsp;</span><span class="mtk9">activates&nbsp;its&nbsp;local&nbsp;scope.</span></span><br><span><span class="mtk15">similarity</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Standardize&nbsp;`sourceA`&nbsp;and&nbsp;`sourceB`&nbsp;for&nbsp;compari</span><span class="mtk9">son.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.stdev</span><span class="mtk13">(</span><span class="mtk33">sourceB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;and&nbsp;return&nbsp;the&nbsp;estimated&nbsp;similarity&nbsp;o</span><span class="mtk9">f&nbsp;`normA`&nbsp;and&nbsp;`normB`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normA</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normA</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">normB</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">normB</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">abSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">a2Sum</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">b2Sum</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;similarity&nbsp;between&nbsp;the&nbsp;`close`&nbsp;and&nbsp;sev</span><span class="mtk9">eral&nbsp;offset&nbsp;`close`&nbsp;series.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.orange</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">4</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;3"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">8</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;4"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.blue</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">similarity</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk12">16</span><span class="mtk13">]</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Similarity&nbsp;5"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，本地代码结果不再对应于每个脚本执行的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单个</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
评估。相反，它们代表</font><strong><font style="vertical-align: inherit;">所有五次</font></strong><font style="vertical-align: inherit;">调用
的本地代码的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">综合</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行时间和执行情况。如下所示，在相同数据上运行此版本的脚本后的结果显示本地代码执行了 137,905 次，是</font><font style="vertical-align: inherit;">
脚本仅包含一个函数调用时的</font><em><font style="vertical-align: inherit;">五倍</font></em><font style="vertical-align: inherit;">
：</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><code dir="auto">similarity()</code><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-User-defined-function-calls-2.BJPTeot1_Z1mNfz1.webp" alt="图像" width="1072" height="386" loading="lazy" decoding="async"></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本的
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本地作用域
包含对</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数的调用时，</font><font style="vertical-align: inherit;">脚本的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻译形式</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会提取函数作用域</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之外的此类调用并</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单独</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">评估它们。因此，Profiler 对调用这些
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数的行的结果</font></font></a> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将不</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括调用所花费的时间</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。请参阅
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#when-requesting-other-contexts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下部分</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以了解更多信息。</font></font></p></div></aside>
<h4 id="when-requesting-other-contexts" class="md-heading"><a href="#when-requesting-other-contexts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请求其他</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上下文时</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine 脚本可以通过调用</font><font style="vertical-align: inherit;">函数系列或</font><font style="vertical-align: inherit;">在
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_indicator"><font style="vertical-align: inherit;">indicator()声明语句中指定替代方案来从其他</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上下文</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请求数据，即与图表数据使用的不同的符号、时间范围或数据修改</font><font style="vertical-align: inherit;">
。</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font><code dir="auto">timeframe</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_indicator"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本从另一个上下文请求数据时，它会评估该上下文中所有必需的范围和计算，如
</font></font><a href="/pine-script-docs/concepts/other-timeframes-and-data"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他时间范围和数据</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">页面中所述。此行为会影响脚本代码区域的运行时间及其执行的次数。</font></font></p>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#single-line-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任何代码行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的 Profiler 信息
代表在</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有必要上下文</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中执行代码的结果</font><font style="vertical-align: inherit;">，这些结果可能包含也可能不包含图表的数据。Pine Script™ 根据脚本的数据请求和输出所需的计算来确定在哪些上下文中执行代码。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一个简单的例子。这个初始脚本仅使用图表的数据进行计算。它使用</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_varip"><font style="vertical-align: inherit;">varip</font></a></font><code dir="auto">pricesArray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键字声明一个变量
</font><font style="vertical-align: inherit;">
，这意味着
分配给它的</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a><font style="vertical-align: inherit;">
在数据历史记录和所有可用的实时刻度中保持不变。每次执行时，脚本都会调用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;">array.push()</font></a><font style="vertical-align: inherit;">
将新的
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;">收盘</font></a><font style="vertical-align: inherit;">
价
推送到</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a><font style="vertical-align: inherit;">中，并</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">绘制</font></a><font style="vertical-align: inherit;">数组</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.size"><font style="vertical-align: inherit;">的大小</font></a><font style="vertical-align: inherit;">。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_varip"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.size"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在日内图表的所有条形图上对脚本进行分析后，我们看到元素的数量与</font></font><code dir="auto">pricesArray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 在第 8 行显示的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.push()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用的执行次数相对应
：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-1.4ixtln-7_gTemj.webp" alt="图像" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="54e"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;chart&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><code dir="auto">pricesArray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，让我们尝试从</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一个上下文</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">评估大小，</font><font style="vertical-align: inherit;">而不是使用图表的数据。下面，我们添加了一个
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用，以
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.size"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.size(pricesArray)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为其</font></font><code dir="auto">expression</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数，以检索在“1D”时间范围内计算的值并绘制该结果。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，Profiler 在第 8 行显示的执行次数仍然与 中的元素数量相对应。但是，由于脚本</font><font style="vertical-align: inherit;">在计算中
</font></font><code dir="auto">pricesArray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不需要图表</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的数据，因此执行的次数并不相同。它只需要初始化</font></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并对所有请求的</font><em><font style="vertical-align: inherit;">每日数据</font></em><font style="vertical-align: inherit;">
评估
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.push()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其价格更新次数与我们当前的日内图表不同：</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-2.COS2z1lh_s4Tg3.webp" alt="图像" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="sv"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`&nbsp;requested&nbsp;fr</span><span class="mtk9">om&nbsp;the&nbsp;daily&nbsp;timeframe.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"1D"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;daily&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本例中请求的 EOD 数据的数据点比我们的日内图表少，因此
</font><font style="vertical-align: inherit;">
在这种情况下
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.push()调用需要的执行次数较少。但是，EOD 源</font></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历史记录限制，这意味着请求的 HTF 数据也可能比用户的图表跨越</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更多的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条形图，具体取决于时间范围、数据提供商和用户的</font></font><a href="https://www.tradingview.com/pricing/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计划</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果此脚本除了请求的每日值之外还直接绘制
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.size"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.size()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值，则需要创建</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两个</font></font></em> <a href="/pine-script-docs/language/arrays"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（每个上下文一个），并
跨图表数据</font><em><font style="vertical-align: inherit;">和</font></em><font style="vertical-align: inherit;">每日时间范围的数据执行
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.push()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，第 5 行上的声明将执行</font><em><font style="vertical-align: inherit;">两次，第 8 行上的结果将反映从评估</font></em><strong><font style="vertical-align: inherit;">两个独立数据</font></strong><font style="vertical-align: inherit;">
集上的</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;">array.push()</font></a><font style="vertical-align: inherit;">调用所累积的时间和执行次数
</font><font style="vertical-align: inherit;">：</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.push"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-3.CPXHEchh_1SVGGO.webp" alt="图像" width="1250" height="384" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="2zo"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"When&nbsp;requesting&nbsp;other&nbsp;contexts&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;`close`&nbsp;value&nbsp;from&nbsp;every&nbsp;</span><span class="mtk9">available&nbsp;price&nbsp;update.</span></span><br><span><span class="mtk18">varip</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">pricesArray</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`close`&nbsp;value&nbsp;into&nbsp;the&nbsp;`pricesArray`</span><span class="mtk9">&nbsp;on&nbsp;each&nbsp;update.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`pricesArray`&nbsp;from&nbsp;the&nbsp;dai</span><span class="mtk9">ly&nbsp;timeframe&nbsp;and&nbsp;the&nbsp;chart's&nbsp;context.</span></span><br><span><span class="mtk9">//&nbsp;Including&nbsp;both&nbsp;in&nbsp;the&nbsp;outputs&nbsp;requires&nbsp;executin</span><span class="mtk9">g&nbsp;line&nbsp;5&nbsp;and&nbsp;line&nbsp;8&nbsp;across&nbsp;BOTH&nbsp;datasets.&nbsp;&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"1D"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;daily&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.size</span><span class="mtk13">(</span><span class="mtk33">pricesArray</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Total&nbsp;number&nbsp;of&nbsp;chart&nbsp;price&nbsp;updates"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要注意的是，当脚本调用包含
</font><font style="vertical-align: inherit;">
本地</font><font style="vertical-align: inherit;">作用域内调用的
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法时，脚本的</font></font></a><font style="vertical-align: inherit;"><em><font style="vertical-align: inherit;">翻译形式</font></em><font style="vertical-align: inherit;">会提取作用</font><strong><font style="vertical-align: inherit;">域外的</font></strong><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">，并将它们依赖的表达式封装在</font><strong><font style="vertical-align: inherit;">单独的函数</font></strong><font style="vertical-align: inherit;">中。脚本执行时，会先评估所需的
</font><font style="vertical-align: inherit;">调用，然后将</font><font style="vertical-align: inherit;">请求的数据
</font><em><font style="vertical-align: inherit;">传递给</font></em><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;">用户定义函数</font></a><font style="vertical-align: inherit;">的
</font><em><font style="vertical-align: inherit;">修改形式</font></em><font style="vertical-align: inherit;">。</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于翻译后的脚本
</font><strong><font style="vertical-align: inherit;">在</font></strong><font style="vertical-align: inherit;">评估其本地范围内未请求的计算之前会单独执行</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据请求，因此，Profiler 对包含对该函数的调用的行的结果</font><strong><font style="vertical-align: inherit;">将不</font></strong><font style="vertical-align: inherit;">包括在其调用或所需表达式上花费的时间</font><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，以下脚本包含一个用户定义
</font></font><code dir="auto">getCompositeAvg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，该函数带有
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用，该调用请求
</font><font style="vertical-align: inherit;">来自指定 的</font><font style="vertical-align: inherit;">
10 个
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.wma"><font style="vertical-align: inherit;">ta.wma()调用的</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_math.avg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">math.avg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () 
，这些调用具有不同的参数。该脚本使用该函数使用</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ticker.heikinashi"><font style="vertical-align: inherit;">Heikin Ashi</font></a><font style="vertical-align: inherit;">股票代码 ID请求平均结果</font><font style="vertical-align: inherit;">
：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.wma"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">length</code><font style="vertical-align: inherit;"></font><code dir="auto">symbol</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ticker.heikinashi"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="49l"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;functions&nbsp;with&nbsp;`request.*()`&nbsp;calls&nbsp;d</span><span class="mtk29">emo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length&nbsp;multiplier"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">tickerID</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ticker.heikinashi</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk15">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbol</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">symbol</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk33">tickerID</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Composite&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">linewidth</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对脚本进行分析后，用户可能会惊讶地发现函数主体内部显示的运行时结果大大</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">超过</font></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单次</font></font></em> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用显示的结果</font></font><code dir="auto">getCompositeAvg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-When-requesting-other-contexts-4.CkN5cmYP_xCyjm.webp" alt="图像" width="1072" height="342" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果之所以这样显示，是因为翻译后的脚本包含内部修改，将</font><font style="vertical-align: inherit;">request.security
 </font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;">()</font></a><font style="vertical-align: inherit;">
调用及其表达式</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移到了函数范围</font></font></em><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">之外，并且在这种情况下，Profiler 除了将这些计算的结果显示在</font></strong><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;">request.security()</font></a><font style="vertical-align: inherit;">行旁边之外，没有其他方法可以表示这些计算的结果
</font><font style="vertical-align: inherit;">
。下面的代码大致说明了翻译后的脚本的样子：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="5rg"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"User-defined&nbsp;functions&nbsp;with&nbsp;`request.*()`&nbsp;calls&nbsp;d</span><span class="mtk29">emo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">multInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length&nbsp;multiplier"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">tickerID</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ticker.heikinashi</span><span class="mtk13">(</span><span class="mtk11">syminfo.tickerid</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk15">secExpr</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span><span class="mtk18">,</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.wma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthMult</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">sec</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">tickerID</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">secExpr</span><span class="mtk13">(</span><span class="mtk33">multInput</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk15">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">s</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">s</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">getCompositeAvg</span><span class="mtk13">(</span><span class="mtk33">sec</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Composite&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">linewidth</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该</font></font><code dir="auto">secExpr()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码代表</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;">request.security()</font></a><font style="vertical-align: inherit;">
用来计算请求上下文中所需表达式</font><font style="vertical-align: inherit;">的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单独函数。</font></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security
 </font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用发生在函数</font><font style="vertical-align: inherit;">之外的
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部作用域中</font></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">getCompositeAvg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻译大大减少了 的本地代码
</font></font><code dir="auto">getCompositeAvg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。它现在仅返回传递给它的值，因为函数所需的所有计算都发生
在其范围</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之外</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。由于这种减少，函数调用的性能结果</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将不会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">反映出数据请求所需计算所花费的任何时间。</font></font></li>
</ul>
<h4 id="insignificant-unused-and-redundant-code" class="md-heading"><a href="#insignificant-unused-and-redundant-code"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不重要、未使用和冗余的</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在检查分析脚本的结果时，务必要了解</font><font style="vertical-align: inherit;">脚本中
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并非所有代码都会影响运行时性能。有些代码不会直接影响性能，例如脚本的声明语句和</font></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_type"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
声明。其他具有不重要表达式的代码区域（例如大多数</font></font><code dir="auto">input.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用、变量引用或
没有重要计算的</font></font><a href="/pine-script-docs/language/variable-declarations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量声明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）对脚本的运行时几乎没有</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。因此，Profiler 不会</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这些类型代码的性能结果。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此外，Pine 脚本不会执行其
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输出</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
</font></font><a href="/pine-script-docs/language/type-system#drawing-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图纸</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
</font></font><a href="/pine-script-docs/writing/debugging#pine-logs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">日志</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等）不依赖的代码区域，因为编译器会在翻译过程中自动</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它们。由于未使用的代码区域对脚本的性能</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有任何</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响，因此 Profiler 不会</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它们的任何结果。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下示例包含一个</font></font><code dir="auto">barsInRange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量和一个
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环，该循环将
当前
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_high"><font style="vertical-align: inherit;">最高价</font></a><font style="vertical-align: inherit;">
和</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_low"><font style="vertical-align: inherit;">最低价之间的每个历史</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收盘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">价加 1 到变量的值
</font><font style="vertical-align: inherit;">。但是，脚本</font><strong><font style="vertical-align: inherit;">不会</font></strong><font style="vertical-align: inherit;">在其输出中使用这些计算，因为它只
</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">绘制</font></a><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;">收盘</font></a><font style="vertical-align: inherit;">价
</font><font style="vertical-align: inherit;">
。因此，脚本的编译形式</font><strong><font style="vertical-align: inherit;">会丢弃</font></strong><font style="vertical-align: inherit;">未使用的代码，只考虑
</font><font style="vertical-align: inherit;">
plot </font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_plot"><font style="vertical-align: inherit;">(close)</font></a><font style="vertical-align: inherit;">
调用。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_high"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_low"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_plot"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 不会显示此脚本的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任何</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果，因为它不执行任何</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-1.CVzX40Kz_HGwJR.webp" alt="图像" width="1072" height="350" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="1cj"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Unused&nbsp;code&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;historical&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;closes&nbsp;over&nbsp;`lengthInput`&nbsp;bars&nbsp;betw</span><span class="mtk9">een&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;`close`&nbsp;price&nbsp;from&nbsp;`i`&nbsp;bars&nbsp;ago.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;1&nbsp;to&nbsp;`barsInRange`&nbsp;if&nbsp;the&nbsp;`pastClose`&nbsp;is&nbsp;be</span><span class="mtk9">tween&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">low</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">high</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`close`&nbsp;price.&nbsp;This&nbsp;is&nbsp;the&nbsp;only&nbsp;output</span><span class="mtk9">.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;Since&nbsp;the&nbsp;outputs&nbsp;do&nbsp;not&nbsp;require&nbsp;any&nbsp;of&nbsp;the&nbsp;abo</span><span class="mtk9">ve&nbsp;calculations,&nbsp;the&nbsp;compiled&nbsp;script&nbsp;will&nbsp;not&nbsp;exec</span><span class="mtk9">ute&nbsp;them.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">虽然该脚本不使用
第 5 行的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_input.int"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input.int()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并丢弃所有相关计算，但“Length”输入</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍会</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出现在脚本的设置中，因为编译器</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全删除未使用的
</font></font><a href="/pine-script-docs/concepts/inputs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输入</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果我们将脚本改为绘制</font></font><code dir="auto">barsInRange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值，则声明的变量和
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不再未被使用，因为输出依赖于它们，并且 Profiler 现在将显示该代码的性能信息：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-2.TBOBJdXS_Z1yftUf.webp" alt="图像" width="1072" height="334" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="60h"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Unused&nbsp;code&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;historical&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;closes&nbsp;over&nbsp;`lengthInput`&nbsp;bars&nbsp;betw</span><span class="mtk9">een&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;`close`&nbsp;price&nbsp;from&nbsp;`i`&nbsp;bars&nbsp;ago.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;1&nbsp;to&nbsp;`barsInRange`&nbsp;if&nbsp;the&nbsp;`pastClose`&nbsp;is&nbsp;be</span><span class="mtk9">tween&nbsp;the&nbsp;current&nbsp;bar's&nbsp;`high`&nbsp;and&nbsp;`low`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">low</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">pastClose</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk11">high</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">barsInRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`barsInRange`&nbsp;value.&nbsp;The&nbsp;above&nbsp;calcula</span><span class="mtk9">tions&nbsp;will&nbsp;execute&nbsp;since&nbsp;the&nbsp;output&nbsp;requires&nbsp;them.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">barsInRange</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Bars&nbsp;in&nbsp;range"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 不会显示
</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第 5 行的声明或</font></font><code dir="auto">barsInRange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第 8 行的声明的性能信息，因为这些行上的表达式不会影响脚本的性能。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果可能，编译器还会简化脚本中的某些冗余代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实例
</font><font style="vertical-align: inherit;">，例如具有相同
</font></font><a href="/pine-script-docs/language/type-system#types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本类型</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值的某些相同表达式形式。这种优化允许编译后的脚本</font><font style="vertical-align: inherit;">在第一次出现时仅执行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次此类计算，并对输出所依赖的每个重复实例</font></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重用</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算结果。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果脚本包含重复代码并且编译器对其进行了简化，则 Profiler 将仅显示该代码</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一次出现</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的结果，因为这是脚本唯一需要计算的时候。</font></font></p>
<p><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.sma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，此脚本包含绘制ta.sma(close, 100)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值的代码行
和绘制</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.sma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.sma(close, 500)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值的代码行</font><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="4ni"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Redundant&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;100-bar&nbsp;SMA&nbsp;of&nbsp;`close`&nbsp;values&nbsp;one&nbsp;time</span><span class="mtk9">.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"100-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.teal</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;500-bar&nbsp;SMA&nbsp;of&nbsp;`close`&nbsp;values&nbsp;12&nbsp;times</span><span class="mtk9">.&nbsp;After&nbsp;compiler&nbsp;optimizations,&nbsp;only&nbsp;the&nbsp;first&nbsp;`ta</span><span class="mtk9">.sma(close,&nbsp;500)`</span></span><br><span><span class="mtk9">//&nbsp;call&nbsp;on&nbsp;line&nbsp;9&nbsp;requires&nbsp;calculation&nbsp;in&nbsp;this&nbsp;cas</span><span class="mtk9">e.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#001aff</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">12</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#4d0bff</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">11</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#7306f7</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#920be9</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">9</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ae11d5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#c618be</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#db20a4</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#eb2c8a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#f73d6f</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#fe5053</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ff6534</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.sma</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"500-bar&nbsp;SMA"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">#ff7a00</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于最后 12 行都包含相同的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.sma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.sma()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用，编译器可以自动简化脚本，以便每次执行只需要评估</font><em><font style="vertical-align: inherit;">一次</font></em></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.sma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.sma(close, 500)，</font></font></a>
<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是重复计算 11 次。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下所示，Profiler 仅显示第 5 行和第 9 行的结果。这些是代码中唯一需要大量计算的部分，因为
在这种情况下，第 10-20 行的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.sma"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.sma()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用是多余的：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-3.B3yrx82E_2jeci8.webp" alt="图像" width="1072" height="368" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一种重复代码优化发生在脚本包含两个或多个
具有相同编译形式的</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时
。在这种情况下，编译器通过</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">冗余函数来简化脚本，并且脚本会将对冗余函数的所有调用视为对</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
定义版本的调用。因此，Profiler 将仅显示第</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数的本地代码性能结果，因为丢弃的“克隆”永远不会执行。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，下面的脚本包含两个
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code dir="auto">metallicRatio()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code dir="auto">calcMetallic()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，用于计算
</font><font style="vertical-align: inherit;">给定阶的指定指数的</font></font><a href="https://en.wikipedia.org/wiki/Metallic_mean" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">金属比：</font></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="co"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Redundant&nbsp;functions&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Controls&nbsp;the&nbsp;base&nbsp;ratio&nbsp;for&nbsp;the&nbsp;`calcMetallic()`&nbsp;</span><span class="mtk9">call.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order1Input</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Order&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Controls&nbsp;the&nbsp;base&nbsp;ratio&nbsp;for&nbsp;the&nbsp;`metallicRatio()`</span><span class="mtk9">&nbsp;call.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order2Input</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Order&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Calculates&nbsp;the&nbsp;value&nbsp;of&nbsp;a&nbsp;metallic&nbsp;ratio&nbsp;wi</span><span class="mtk9">th&nbsp;a&nbsp;given&nbsp;`order`,&nbsp;raised&nbsp;to&nbsp;a&nbsp;specified&nbsp;`exponen</span><span class="mtk9">t`.</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@param</span><span class="mtk9">&nbsp;order&nbsp;&nbsp;&nbsp;&nbsp;Determines&nbsp;the&nbsp;base&nbsp;ratio&nbsp;used.&nbsp;1&nbsp;=&nbsp;Gold</span><span class="mtk9">en&nbsp;Ratio,&nbsp;2&nbsp;=&nbsp;Silver&nbsp;Ratio,&nbsp;3&nbsp;=&nbsp;Bronze&nbsp;Ratio,&nbsp;and&nbsp;</span><span class="mtk9">so&nbsp;on.</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@param</span><span class="mtk9">&nbsp;exponent&nbsp;The&nbsp;exponent&nbsp;applied&nbsp;to&nbsp;the&nbsp;ratio.</span></span><br><span><span class="mtk15">metallicRatio</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">exponent</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.pow</span><span class="mtk13">((</span><span class="mtk33">order</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk12">4.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">order</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">exponent</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;function&nbsp;with&nbsp;the&nbsp;same&nbsp;signature&nbsp;and&nbsp;body</span><span class="mtk9">&nbsp;as&nbsp;`metallicRatio()`.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;script&nbsp;discards&nbsp;this&nbsp;functio</span><span class="mtk9">n&nbsp;and&nbsp;treats&nbsp;`calcMetallic()`&nbsp;as&nbsp;an&nbsp;alias&nbsp;for&nbsp;`met</span><span class="mtk9">allicRatio()`.</span></span><br><span><span class="mtk15">calcMetallic</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">exp</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">math.pow</span><span class="mtk13">((</span><span class="mtk33">ord</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk12">4.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">ord</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">exp</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;results&nbsp;from&nbsp;a&nbsp;`calcMetallic()`&nbsp;and&nbsp;`m</span><span class="mtk9">etallicRatio()`&nbsp;call.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">calcMetallic</span><span class="mtk13">(</span><span class="mtk33">order1Input</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Ratio&nbsp;1"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.orange</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">metallicRatio</span><span class="mtk13">(</span><span class="mtk33">order2Input</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">5</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Ratio&nbsp;2"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.maroon</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽管函数和参数名称不同，但这两个函数在其他方面是相同的，编译器在翻译脚本时会检测到这一点。在这种情况下，它</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会丢弃</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">冗余
</font></font><code dir="auto">calcMetallic()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，并且编译后的脚本会将该
</font></font><code dir="auto">calcMetallic()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用视为</font></font><code dir="auto">metallicRatio()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正如我们在这里看到的，Profiler 显示了第 21 行和第 22 行的
</font></font><code dir="auto">calcMetallic()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code dir="auto">metallicRatio()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用的性能信息，但它没有</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第 18 行函数本地代码的任何结果。</font></font><code dir="auto">calcMetallic()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
相反，Profiler 在函数内第 13 行的信息反映了</font><strong><font style="vertical-align: inherit;">两个</font></strong><a href="/pine-script-docs/writing/profiling-and-optimization#user-defined-function-calls"><font style="vertical-align: inherit;">函数调用</font></a></font><code dir="auto">metallicRatio()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的本地代码结果</font><font style="vertical-align: inherit;">：</font></font><strong><font style="vertical-align: inherit;"></font></strong>
<a href="/pine-script-docs/writing/profiling-and-optimization#user-defined-function-calls"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Interpreting-profiled-results-Insignificant-unused-and-redundant-code-4.DrYo57fh_Z1tHCEy.webp" alt="图像" width="1072" height="416" loading="lazy" decoding="async"></p>
<h3 id="a-look-into-the-profilers-inner-workings" class="md-heading"><a href="#a-look-into-the-profilers-inner-workings"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解 Profiler 的内部</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工作原理</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Profiler 使用专门的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部函数</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包装所有必要的代码区域，以跟踪和收集脚本执行过程中所需的信息。然后，它将信息传递给其他计算，这些计算会在 Pine Editor 中组织和显示性能结果。本节让用户了解 Profiler 如何应用内部函数包装 Pine 代码并收集性能数据。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler使用两个主要的内部</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（非 Pine）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数包装重要代码，以方便运行时分析。第一个函数检索脚本执行过程中特定点的当前系统时间，第二个函数将累计运行时间和执行数据映射到特定代码区域。我们在本说明中分别将这些函数表示为</font></font><code dir="auto">System.timeNow()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code dir="auto">registerPerf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当 Profiler 检测到需要分析的代码时，它会
</font></font><code dir="auto">System.timeNow()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在代码上方添加，以获取执行前的初始时间。然后，它会</font></font><code dir="auto">registerPerf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在代码下方添加，以映射和累积已用时间和执行次数。每次调用时添加的已用时间</font></font><code dir="auto">registerPerf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">执行</font><em><font style="vertical-align: inherit;">后的</font></em></font><code dir="auto">System.timeNow()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值
减去</font><font style="vertical-align: inherit;">执行</font><em><font style="vertical-align: inherit;">前的值。</font></em></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伪代码概述了</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#single-line-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单行代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的这个过程
</font><font style="vertical-align: inherit;">，其中</font></font><code dir="auto">_startX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示该行的开始时间</font></font><code dir="auto">lineX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="167"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span></span><br><span><span class="mtk18">&lt;</span><span class="mtk33">code_line_to_analyze</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineX</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码块</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的过程类似
</font><font style="vertical-align: inherit;">。不同之处在于</font></font><code dir="auto">registerPerf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用将数据映射到一系列</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是单行。这里，</font></font><code dir="auto">lineX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表示</font><font style="vertical-align: inherit;">代码块中的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一</font></font></em><font style="vertical-align: inherit;"></font><code dir="auto">lineY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行，表示块的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一行：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="5s1"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span></span><br><span><span class="mtk18">&lt;</span><span class="mtk33">code_block_to_analyze</span><span class="mtk18">&gt;</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineX</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lineY</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在上面的代码片段中，、</font></font><code dir="auto">long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code dir="auto">System.timeNow()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代表
</font></font><code dir="auto">registerPerf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 代码。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在让我们看看 Profiler 如何包装完整的脚本及其所有重要代码。我们将从这个脚本开始，它计算三个伪随机序列并显示它们的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_math.avg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平均</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果。该脚本利用</font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;">用户定义类型</font></a><font style="vertical-align: inherit;">的
</font></font><a href="/pine-script-docs/language/objects"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来存储伪随机状态，利用一种
</font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;">方法</font></a><font style="vertical-align: inherit;">
来计算新值并更新状态，以及利用</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if…else if</font></a><font style="vertical-align: inherit;">
结构根据生成的值更新每个序列：</font></font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="7ia"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiler's&nbsp;inner&nbsp;workings&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">seedInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">12345</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Seed"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">type</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">state</span></span><br><span><span></span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">generate</span><span class="mtk13">(</span><span class="mtk18 mtkb">LCG</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">16807</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">.</span><span class="mtk15">new</span><span class="mtk13">(</span><span class="mtk33">seedInput</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk33">val0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Average&nbsp;pseudorandom&nbsp;result"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 将使用
</font><font style="vertical-align: inherit;">上述</font><strong><font style="vertical-align: inherit;">内部函数包装整个脚本和所有必要的代码区域（不包括任何</font></strong></font><a href="/pine-script-docs/writing/profiling-and-optimization#insignificant-unused-and-redundant-code"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不重要、未使用或冗余的代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），以收集性能数据。下面的</font><em><font style="vertical-align: inherit;">伪代码</font></em><font style="vertical-align: inherit;">演示了此过程如何应用于上述脚本：</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="2lf"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startMain</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;script's&nbsp;overall&nbsp;execution.</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;&lt;Additional&nbsp;internal&nbsp;code&nbsp;executes&nbsp;here&gt;</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiler's&nbsp;inner&nbsp;workings&nbsp;demo"</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Declaration&nbsp;statements&nbsp;do&nbsp;not&nbsp;require&nbsp;profiling</span><span class="mtk9">.</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">seedInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">12345</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Seed"</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declaration&nbsp;without&nbsp;significant&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span></span></span><br><span><span class="mtk18">type</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Type&nbsp;declarations&nbsp;do&nbsp;not&nbsp;require&nbsp;profiling.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">state</span></span><br><span><span></span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">generate</span><span class="mtk13">(</span><span class="mtk18 mtkb">LCG</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Function&nbsp;signature&nbsp;does&nbsp;not&nbsp;affect&nbsp;runtime.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declaration&nbsp;without&nbsp;significant&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start11</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;loop&nbsp;block&nbsp;that&nbsp;begins&nbsp;on&nbsp;li</span><span class="mtk9">ne&nbsp;11.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;header&nbsp;calculations&nbsp;are&nbsp;not&nbsp;independently&nbsp;</span><span class="mtk9">wrapped.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start12</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;12.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk12">16807</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start12</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line12</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;12.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start13</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;13.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk33">state</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk12">2147483647</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start13</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line13</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;13.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start11</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line11</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line13</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;the&nbsp;block&nbsp;(line&nbsp;1</span><span class="mtk9">1&nbsp;-&nbsp;13).&nbsp;&nbsp;&nbsp;&nbsp;</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start14</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;14.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">generations</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start14</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line14</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;14.</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start16</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;16.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">LCG</span><span class="mtk1">.</span><span class="mtk15">new</span><span class="mtk13">(</span><span class="mtk33">seedInput</span><span class="mtk13">)</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start16</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line16</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;16.</span></span><br><span><span></span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Variable&nbsp;declarations&nbsp;without&nbsp;significant&nbsp;calcu</span><span class="mtk9">lations.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start22</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;the&nbsp;`if`&nbsp;block&nbsp;that&nbsp;begins&nbsp;on&nbsp;li</span><span class="mtk9">ne&nbsp;22.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrapped.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start23</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;23.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start23</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line23</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;23.</span></span><br><span><span></span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`else&nbsp;if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrappe</span><span class="mtk9">d.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start25</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;25.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val1</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start25</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line25</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;25.</span></span><br><span><span></span></span><br><span><span class="mtk18">else</span><span class="mtk1">&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;`else&nbsp;if`&nbsp;statement&nbsp;is&nbsp;not&nbsp;independently&nbsp;wrappe</span><span class="mtk9">d.</span></span><br><span><span></span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start27</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;27.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">val2</span><span class="mtk1">&nbsp;</span><span class="mtk18">*=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">lcg</span><span class="mtk1">.</span><span class="mtk15">generate</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start27</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line27</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;27.</span></span><br><span><span></span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start22</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line22</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line28</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;the&nbsp;block&nbsp;(line&nbsp;2</span><span class="mtk9">2&nbsp;-&nbsp;28).</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">long</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start29</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Start&nbsp;time&nbsp;for&nbsp;line&nbsp;29.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk33">val0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">val2</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Average&nbsp;pseudorandom&nbsp;result"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk13">)</span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_start29</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">line29</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;performance&nbsp;info&nbsp;for&nbsp;line&nbsp;29.</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;&lt;Additional&nbsp;internal&nbsp;code&nbsp;executes&nbsp;here&gt;</span></span><br><span><span></span></span><br><span><span class="mtk15">registerPerf</span><span class="mtk13">(</span><span class="mtk33">System</span><span class="mtk1">.</span><span class="mtk15">timeNow</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">_startMain</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">total</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk9">//&nbsp;Register&nbsp;the&nbsp;script's&nbsp;overall&nbsp;performance&nbsp;info.</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此示例是</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伪代码，提供了 Profiler 用于收集性能数据的</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部计算</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的基本概述</font><font style="vertical-align: inherit;">。将此示例保存在 Pine Editor 中将导致编译错误，因为</font></font><code dir="auto">long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code dir="auto">System.timeNow()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code dir="auto">registerPerf()</code> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不代表</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 代码。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler 封装脚本时使用的这些内部计算需要</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">额外的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算资源，这就是脚本在分析时运行时间</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">增加的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因。程序员应始终将结果解释为</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">估计值</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，因为它们反映了脚本在包含额外计算的情况下的性能。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行包装的脚本收集性能数据后，
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">额外的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部计算会组织结果并在 Pine 编辑器内显示相关信息：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-A-look-into-the-profilers-inner-workings-1.wt5GoYky_Z1cXiWC.webp" alt="图像" width="1072" height="526" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;">代码块</font></a><font style="vertical-align: inherit;">的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“行时间”</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算</font><font style="vertical-align: inherit;">也发生在此阶段，因为 Profiler 无法单独包装</font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;">循环头或</font></a><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if</font></a><font style="vertical-align: inherit;">或
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;">switch</font></a><font style="vertical-align: inherit;">
结构</font><font style="vertical-align: inherit;">
中的条件语句
。此字段的值表示</font><font style="vertical-align: inherit;">块的总时间与其本地代码时间总和之间的
</font><em><font style="vertical-align: inherit;">差值，这就是为什么</font></em><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;">switch</font></a><font style="vertical-align: inherit;">
块或
</font><font style="vertical-align: inherit;">带有</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">else if表达式的</font></a><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if块的“行时间”值表示结构的</font></a><strong><font style="vertical-align: inherit;">所有</font></strong><font style="vertical-align: inherit;">条件语句
所花费的时间</font><font style="vertical-align: inherit;">，而不仅仅是块的</font><em><font style="vertical-align: inherit;">初始代码</font></em><font style="vertical-align: inherit;">行。如果程序员需要此类块中每个条件表达式的更详细信息，他们可以将逻辑重新组织为
</font><em><font style="vertical-align: inherit;">嵌套的</font></em><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if</font></a><font style="vertical-align: inherit;">
结构，如此处
</font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;">所述</font></a><font style="vertical-align: inherit;">。</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em>
<a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法收集任何所需的</font></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算的单独性能数据</font><font style="vertical-align: inherit;">并在 Pine Editor 中显示其结果。因此，Profiler 显示的脚本中所有代码区域的时间值加起来</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">达到其总运行时间的 100%。</font></font></p></div></aside>
<h3 id="profiling-across-configurations" class="md-heading"><a href="#profiling-across-configurations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">跨</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置分析</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当代码的</font></font><a href="https://en.wikipedia.org/wiki/Time_complexity" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间复杂度</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不是恒定的或其执行模式随其输入、函数参数或可用数据而变化时，通常明智的做法是跨</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不同的配置</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和数据馈送对代码进行分析，以便更全面地了解其总体性能。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，这个简单的脚本使用
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for循环来计算当前</font></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收盘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
价与</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前价格</font><font style="vertical-align: inherit;">之间的平方差之和
，然后</font><font style="vertical-align: inherit;">
在每个柱状图上绘制该和的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_math.sqrt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平方根</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在这种情况下，直接影响计算的运行时间，因为它决定了循环执行其本地代码的次数：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="xq"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Profiling&nbsp;across&nbsp;configurations&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;previous&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.&nbsp;D</span><span class="mtk9">irectly&nbsp;affects&nbsp;the&nbsp;number&nbsp;of&nbsp;loop&nbsp;iterations.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">25</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;squared&nbsp;distances&nbsp;from&nbsp;the&nbsp;current&nbsp;`cl</span><span class="mtk9">ose`&nbsp;to&nbsp;`lengthInput`&nbsp;past&nbsp;`close`&nbsp;values.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">total</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Look&nbsp;back&nbsp;across&nbsp;`lengthInput`&nbsp;bars&nbsp;and&nbsp;accumul</span><span class="mtk9">ate&nbsp;squared&nbsp;distances.</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">total</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">distance</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;square&nbsp;root&nbsp;of&nbsp;the&nbsp;`total`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">math.sqrt</span><span class="mtk13">(</span><span class="mtk33">total</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们尝试使用不同的</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值来分析此脚本。首先，我们将使用默认值 25。Profiler 对此次特定运行的结果显示，该脚本在约 96.7 毫秒内完成了 20,685 次执行：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-1.DH6uvleV_15wBst.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我们在脚本的设置中将输入的值增加到 50。本次运行的结果显示，脚本的总运行时间为 194.3 毫秒，接近</font><font style="vertical-align: inherit;">上次运行时间的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两倍：</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-2.ggfGlT9L_ZW6q7G.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在下一次运行中，我们将输入的值更改为 200。这一次，Profiler 的结果显示脚本在大约 0.8 秒内完成所有执行，大约是</font><font style="vertical-align: inherit;">上次运行时间的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">四倍：</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Profiling-across-configurations-3.CZLkQfeW_Z1lXDjU.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这些观察中我们可以看出，脚本的运行时间似乎</font><font style="vertical-align: inherit;">与值成</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">线性</font></font></em><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比例，排除可能影响性能的其他因素，正如人们所预料的那样，因为脚本的大部分计算发生在循环内，并且输入的值控制循环必须执行的次数。</font></font></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在评估脚本性能如何随其输入或数据而变化时，
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析每个配置通常是明智之举，以减少异常值的影响。请参阅</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#repetitive-profiling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下部分</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解更多信息。</font></font></p></div></aside>
<h3 id="repetitive-profiling" class="md-heading"><a href="#repetitive-profiling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本可用的运行时资源会随时间而</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变化。因此，评估代码区域（即使是复杂</font></font></em><font style="vertical-align: inherit;"></font><a href="https://en.wikipedia.org/wiki/Time_complexity" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">度</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为）
</font><font style="vertical-align: inherit;">所需的时间也会因执行次数</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而波动</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并且 Profiler 显示的累积性能结果</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">随着每次独立脚本运行而变化。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户可以通过多次</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重启</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本并对每次独立运行进行分析来增强分析能力。对每次分析运行的结果取平均值并评估运行时结果的离散度可以帮助用户建立更可靠的性能基准并减少异常值</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">异常长或短的运行时间）对其结论的影响。</font></font></p>
<p><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将虚拟输入</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（即不执行任何操作的输入）合并</font><font style="vertical-align: inherit;">到脚本代码中是一种简单的技术，可让用户在分析时</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新启动</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它。输入不会直接影响任何计算或输出。但是，当用户在脚本设置中更改其值时，脚本会重新启动，并且 Profiler 会重新分析已执行的代码。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，此脚本
通过具有固定大小的</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a><font style="vertical-align: inherit;">对具有恒定种子的伪随机值
</font></font><a href="/pine-script-docs/language/arrays#using-an-array-as-aqueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行排队</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，并计算并绘制每个条形图上的数组
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.avg"><font style="vertical-align: inherit;">平均值</font></a><font style="vertical-align: inherit;">
。出于分析目的，脚本包含一个
</font><font style="vertical-align: inherit;">变量，该变量分配有
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_input.int"><font style="vertical-align: inherit;">input.int()值。除了允许我们在每次更改其值时</font></a><em><font style="vertical-align: inherit;">重新启动</font></em><font style="vertical-align: inherit;">脚本外，</font><font style="vertical-align: inherit;">
输入在代码中不执行任何操作：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.avg"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">dummyInput</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_input.int"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="5sz"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Repetitive&nbsp;profiling&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;input&nbsp;not&nbsp;connected&nbsp;to&nbsp;script&nbsp;calculations.&nbsp;Ch</span><span class="mtk9">anging&nbsp;its&nbsp;value&nbsp;in&nbsp;the&nbsp;"Inputs"&nbsp;tab&nbsp;restarts&nbsp;the&nbsp;</span><span class="mtk9">script.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">dummyInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Dummy&nbsp;input"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;pseudorandom&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randValues</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">2500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;a&nbsp;new&nbsp;`math.random()`&nbsp;value&nbsp;with&nbsp;a&nbsp;fixed&nbsp;`</span><span class="mtk9">seed`&nbsp;into&nbsp;the&nbsp;`randValues`&nbsp;array&nbsp;and&nbsp;remove&nbsp;the&nbsp;o</span><span class="mtk9">ldest&nbsp;value.</span></span><br><span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">))</span></span><br><span><span class="mtk16">array.shift</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;average&nbsp;of&nbsp;all&nbsp;elements&nbsp;in&nbsp;the&nbsp;`randVa</span><span class="mtk9">lues`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">array.avg</span><span class="mtk13">(</span><span class="mtk33">randValues</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Pseudorandom&nbsp;average"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一次脚本运行后，Profiler 显示执行所有图表数据花费了 308.6 毫秒：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-1.CfionGK2_pmOYe.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，让我们在脚本设置中更改虚拟输入的值，以重新启动它而不更改计算。这一次，它在 424.6 毫秒内完成了相同的代码执行，比上次运行长 116 毫秒：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-2.LouNiZpq_o9WWS.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再次重新启动脚本，结果又发生了变化。第三次运行时，脚本在 227.4 毫秒内完成了所有代码执行，这是迄今为止最短的时间：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Pine-profiler-Repetitive-profiling-3.UGJOj4nF_Z1p4czi.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复此过程几次并记录每次运行的结果后，可以手动计算它们的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平均值</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来估计脚本的预期总运行时间：</font></font></p>
<p><code dir="auto">AverageTime = (time1 + time2 + ... + timeN) / N</code></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无论是单次运行还是多次运行，了解结果会有所不同</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">至关重要</font><font style="vertical-align: inherit;">。虽然对多次运行的脚本结果进行平均可以帮助得出更稳定的性能估计，但这种估计并非</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不受</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方差影响。</font></font></p></div></aside>
<h2 id="optimization" class="md-heading"><a href="#optimization"> <span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码优化</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（不要与指标或策略优化混淆）涉及修改脚本的源代码以缩短执行时间、提高资源效率和可扩展性。当程序员需要增强运行时性能时，他们可以使用各种方法来优化脚本，具体取决于脚本的计算内容。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从根本上讲，优化 Pine 代码所用的大部分技术都涉及</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键计算的次数，或
</font><font style="vertical-align: inherit;">用简化公式或内置公式</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换重要计算。这两种范式经常重叠。</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下部分解释了程序员可以应用来优化其 Pine Script™ 代码的几个简单的概念。</font></font></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在寻找优化脚本的方法之前，
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">先对其进行分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以评估其性能并确定</font><font style="vertical-align: inherit;">最能从优化中受益的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键代码区域。</font></font></strong><font style="vertical-align: inherit;"></font></p></div></aside>
<h3 id="using-built-ins" class="md-heading"><a href="#using-built-ins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置函数</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 具有多种</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数和变量，可帮助简化脚本创建。Pine 的许多内置函数都具有内部优化功能，可帮助最大限度地提高效率并最大限度地缩短执行时间。因此，优化 Pine 代码的最简单方法之一是尽可能在脚本的计算中利用这些高效的内置函数。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一个例子，其中可以用简洁的内置调用替换用户定义的计算，以大幅提高性能。假设程序员想要计算指定数量的条形图的系列的最高值。不熟悉 Pine 所有内置功能的人可能会使用如下代码来完成任务，该代码</font><font style="vertical-align: inherit;">
在每个条形图上使用</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来比较系列的历史值</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="2m5"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;highest&nbsp;</span><span class="mtk9">`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk15">pineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者，可以通过减少循环执行的次数来设计更优化的 Pine 函数，因为</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅在特定条件发生时才需要迭代历史记录以获得结果：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3qo"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;h</span><span class="mtk9">ighest&nbsp;`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;version&nbsp;only&nbsp;requires&nbsp;a&nbsp;loop&nbsp;when</span><span class="mtk9">&nbsp;the&nbsp;highest&nbsp;value&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;window,&nbsp;the</span><span class="mtk9">&nbsp;`length`&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changes,&nbsp;or&nbsp;when&nbsp;the&nbsp;number&nbsp;of&nbsp;bars&nbsp;fi</span><span class="mtk9">rst&nbsp;becomes&nbsp;sufficient&nbsp;to&nbsp;calculate&nbsp;the&nbsp;result.&nbsp;</span></span><br><span><span class="mtk15">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.highest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.highest()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数将优于这</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两种</font></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">pineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实现，因为其内部计算经过高度优化，可实现高效执行。下面，我们创建了一个脚本，绘制了调用、</font></font><code dir="auto">fasterPineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.highest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.highest()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的结果，
以使用</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
比较它们的性能
</font><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="2wy"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5&nbsp;</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Using&nbsp;built-ins&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;highest&nbsp;</span><span class="mtk9">`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk15">pineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;user-defined&nbsp;function&nbsp;to&nbsp;calculate&nbsp;the&nbsp;h</span><span class="mtk9">ighest&nbsp;`source`&nbsp;value&nbsp;over&nbsp;`length`&nbsp;bars.</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;version&nbsp;only&nbsp;requires&nbsp;a&nbsp;loop&nbsp;when</span><span class="mtk9">&nbsp;the&nbsp;highest&nbsp;value&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;window,&nbsp;the</span><span class="mtk9">&nbsp;`length`&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changes,&nbsp;or&nbsp;when&nbsp;the&nbsp;number&nbsp;of&nbsp;bars&nbsp;fi</span><span class="mtk9">rst&nbsp;becomes&nbsp;sufficient&nbsp;to&nbsp;calculate&nbsp;the&nbsp;result.&nbsp;</span></span><br><span><span class="mtk15">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">or</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">])</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">else</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk33">result</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">pineHighest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">fasterPineHighest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对 20,735 次脚本执行的
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示
，对 的调用</font></font><code dir="auto">pineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行时间最长，运行时间为 57.9 毫秒，约占脚本总运行时间的 69.3%。该
</font></font><code dir="auto">fasterPineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用的执行效率更高，因为它仅花费约 16.9 毫秒（约占总运行时间的 20.2%）来计算相同的值。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然而，
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迄今为止</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最有效的是</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.highest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.highest()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用，它只需要 3.2 毫秒（约占总运行时间的 3.8%）即可执行所有图表的数据并在本次运行中计算相同的值：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Using-built-ins-1.CXnfIZo4_ZWjpAS.webp" alt="图像" width="1072" height="564" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">虽然这些结果有效地证明了内置函数的性能优于
</font><font style="vertical-align: inherit;">带有 20 个小参数</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的用户定义函数</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但必须考虑到函数所需的计算</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随参数的值而变化。因此，我们可以在使用
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-across-configurations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不同参数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时对代码进行性能分析，以衡量其运行时的扩展情况。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我们将</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个函数调用中的参数从 20 更改为 200，然后
再次</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析脚本</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以观察性能变化。</font></font><code dir="auto">pineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本次运行中该函数所花费的时间增加到约 0.6 秒（约占总运行时间的 86%），该
</font></font><code dir="auto">fasterPineHighest()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数所花费的时间增加到约 75 毫秒。
</font><font style="vertical-align: inherit;">
另一方面，</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.highest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.highest()函数的运行时间</font></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发生显著变化。这次大约花费了 5.8 毫秒，仅比上次运行多了几毫秒。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">换句话说，虽然我们的
</font></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本次运行中由于参数增加而经历了显著的运行时间增长
</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但内置
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.highest"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.highest()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数的运行时间变化在这种情况下相对较小，从而进一步强调了其性能优势：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Using-built-ins-2.wlIsvoLn_Z1yQ1xR.webp" alt="图像" width="1072" height="564" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在许多情况下，脚本的运行时可受益于使用内置函数（如果适用）。但是，使用内置函数所实现的相对性能优势取决于脚本的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高影响代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和所使用的特定内置函数。无论如何，在探索优化解决方案时，应始终
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对其脚本进行性能分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（最好是
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#repetitive-profiling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本例中函数执行的计算也取决于图表数据的顺序。因此，程序员也可以通过跨
</font><font style="vertical-align: inherit;">不同</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-across-configurations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据集分析脚本来进一步了解其总体性能。</font></font></a><font style="vertical-align: inherit;"></font></li>
</ul>
<h3 id="reducing-repetition" class="md-heading"><a href="#reducing-repetition"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 编译器可以自动简化某些类型的
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#insignificant-unused-and-redundant-code"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，无需程序员干预。但是，这种自动过程有其局限性。如果脚本包含编译器</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法减少的重复计算，程序员可以</font></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少重复</font><font style="vertical-align: inherit;">以提高脚本的性能。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，此脚本包含一个</font></font><code dir="auto">valuesAbove()</code>
<a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，该方法计算数组中指定索引处元素上方的元素数量
。该脚本</font><font style="vertical-align: inherit;">使用计算的绘制</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后一个索引处元素上方的值数量</font><font style="vertical-align: inherit;">。它计算在</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;">switch</font></a><font style="vertical-align: inherit;">
结构</font><font style="vertical-align: inherit;">中
调用</font><font style="vertical-align: inherit;">其所有 10 个条件表达式的：</font></font><code dir="auto">data</code><font style="vertical-align: inherit;"></font><code dir="auto">plotColor</code><font style="vertical-align: inherit;"></font><code dir="auto">plotColor</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="w8"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;repetition&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Counts&nbsp;the&nbsp;number&nbsp;of&nbsp;elements&nbsp;in&nbsp;`this`&nbsp;array&nbsp;abo</span><span class="mtk9">ve&nbsp;the&nbsp;element&nbsp;at&nbsp;a&nbsp;specified&nbsp;`index`.</span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">valuesAbove</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Returns&nbsp;`color.purple`&nbsp;with&nbsp;a&nbsp;varying&nbsp;transparenc</span><span class="mtk9">y&nbsp;based&nbsp;on&nbsp;the&nbsp;`valuesAbove()`.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;number&nbsp;values&nbsp;in&nbsp;the&nbsp;`data`&nbsp;array&nbsp;abov</span><span class="mtk9">e&nbsp;the&nbsp;value&nbsp;at&nbsp;its&nbsp;last&nbsp;index.&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此脚本的分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示
</font><font style="vertical-align: inherit;">，它执行了 21,201 次，耗时约 2.5 秒。对脚本运行时影响最大的代码区域是
</font><font style="vertical-align: inherit;">从第 8 行开始的本地范围
</font><font style="vertical-align: inherit;">内的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for循环和从第 21 行开始的</font></font></a><font style="vertical-align: inherit;"><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;">switch</font></a><font style="vertical-align: inherit;">
块：</font></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_switch"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-1.DzXiqnj9_Z1IB5Dn.webp" alt="图像" width="1072" height="616" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，显示的本地代码的执行次数
</font></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">远远</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大于</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本全局范围内的代码的执行次数，因为脚本每次执行最多调用该方法 11 次，而函数
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#user-defined-function-calls"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本地代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的结果反映了每次单独调用的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间和执行次数：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-2.QnMs1Dg3_ZE1OU8.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽管每次</font></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用都使用</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相同的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数并返回</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相同的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果，但编译器无法在翻译过程中自动为我们减少此代码。我们需要自己完成这项工作。我们可以通过将的值分配</font></font><code dir="auto">data.valuesAbove(99)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并</font><font style="vertical-align: inherit;">在需要结果的所有其他区域中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复使用该值来优化此脚本。</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在下面的版本中，我们通过添加一个</font></font><code dir="auto">count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量来引用该</font></font><code dir="auto">data.valuesAbove(99)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值来修改脚本。脚本在</font></font><code dir="auto">plotColor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算和
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_plot"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plot()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用中使用此变量：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="2pa"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;repetition&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Counts&nbsp;the&nbsp;number&nbsp;of&nbsp;elements&nbsp;in&nbsp;`this`&nbsp;array&nbsp;abo</span><span class="mtk9">ve&nbsp;the&nbsp;element&nbsp;at&nbsp;a&nbsp;specified&nbsp;`index`.</span></span><br><span><span class="mtk18">method</span><span class="mtk1">&nbsp;</span><span class="mtk33">valuesAbove</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">value</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">reference</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;values&nbsp;in&nbsp;the&nbsp;`data`&nbsp;array&nbsp;above&nbsp;the&nbsp;v</span><span class="mtk9">alue&nbsp;at&nbsp;its&nbsp;last&nbsp;index.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">valuesAbove</span><span class="mtk13">(</span><span class="mtk12">99</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Returns&nbsp;`color.purple`&nbsp;with&nbsp;a&nbsp;varying&nbsp;transparenc</span><span class="mtk9">y&nbsp;based&nbsp;on&nbsp;the&nbsp;`valuesAbove()`.</span></span><br><span><span class="mtk18 mtkb">color</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk18">switch</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk1">&nbsp;&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">count</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;=</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.new</span><span class="mtk13">(</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`count`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">count</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">plotColor</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">style</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">plot.style_area</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">经过此修改，
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示性能显著提高，因为脚本现在只需要在每次执行时评估</font><strong><font style="vertical-align: inherit;">一次</font></strong></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font><font style="vertical-align: inherit;">，而不是最多 11 次：</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-repetition-3.Nge1aqtk_2w60SG.webp" alt="图像" width="1072" height="672" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于此脚本仅调用</font></font><code dir="auto">valuesAbove()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次，因此该
</font></font><a href="/pine-script-docs/language/methods#user-defined-methods"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本地代码现在将反映该特定调用的结果。请参阅
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#user-defined-function-calls"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本节</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以了解有关解释分析函数和方法调用结果的更多信息。</font></font></li>
</ul>
<h3 id="minimizing-request-calls" class="md-heading"><a href="#minimizing-request-calls"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽量减少 `request.*()`</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命名空间中的内置函数允许脚本从</font><a href="/pine-script-docs/concepts/other-timeframes-and-data"><font style="vertical-align: inherit;">其他上下文</font></a></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中检索数据
</font><font style="vertical-align: inherit;">。虽然这些函数在许多应用程序中都提供了实用性，但重要的是要考虑到每次调用这些函数都会对脚本的资源使用产生重大影响。</font></font><a href="/pine-script-docs/concepts/other-timeframes-and-data"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单个脚本最多可以包含 40 次对</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数系列的调用。但是，用户应努力将脚本的
</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用次数保持在此限制</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以尽可能降低数据请求对性能的影响。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当脚本使用多个
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;">request.security()</font></a><font style="vertical-align: inherit;">
或
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security_lower_tf"><font style="vertical-align: inherit;">request.security_lower_tf()调用从</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同一</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上下文请求多个表达式的值时</font><font style="vertical-align: inherit;">
，优化此类请求的一种有效方法是将它们</font><em><font style="vertical-align: inherit;">压缩</font></em><font style="vertical-align: inherit;">为使用
</font><a href="/pine-script-docs/concepts/other-timeframes-and-data#tuples"><font style="vertical-align: inherit;">元组</font></a><font style="vertical-align: inherit;">作为参数的</font><font style="vertical-align: inherit;">单个调用</font><font style="vertical-align: inherit;">。这种优化不仅有助于缩短请求的运行时间，还有助于减少脚本的</font><em><font style="vertical-align: inherit;">内存使用量</font></em><font style="vertical-align: inherit;">和编译大小。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security_lower_tf"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/other-timeframes-and-data#tuples"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">expression</code><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">举一个简单的例子，以下脚本
使用对</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;">request.security()</font></a><font style="vertical-align: inherit;">
的九个单独调用从指定符号请求具有不同长度的
九个</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.percentrank"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ta.percentrank()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值。然后，它将所有九个请求的值</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">绘制</font></a><font style="vertical-align: inherit;">在图表上，以在输出中使用它们：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="5ss"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;`request.*()`&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;symbol&nbsp;to&nbsp;request&nbsp;data&nbsp;from.</span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.symbol</span><span class="mtk13">(</span><span class="mtk29">"BINANCE:BTCUSDT"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Symbol"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Request&nbsp;9&nbsp;`ta.percentrank()`&nbsp;values&nbsp;from&nbsp;the&nbsp;`s</span><span class="mtk9">ymbolInput`&nbsp;context&nbsp;using&nbsp;9&nbsp;`request.security()`&nbsp;c</span><span class="mtk9">alls.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank1</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank2</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank3</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank4</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank5</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank6</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank7</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank8</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">))</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank9</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`reqRank*`&nbsp;values.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank1</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank9</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对脚本进行分析的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果
</font><font style="vertical-align: inherit;">显示，脚本花费了 340.8 毫秒来完成其请求并绘制此运行中的值：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-request-calls-1.Canv49So_1Cn30c.webp" alt="图像" width="1072" height="502" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于所有
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security()调用都从</font></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同一上下文</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请求数据</font><font style="vertical-align: inherit;">，我们可以将它们全部合并到使用
</font><a href="/pine-script-docs/concepts/other-timeframes-and-data#tuples"><font style="vertical-align: inherit;">元组</font></a><font style="vertical-align: inherit;">作为参数的单个</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用中，
从而优化代码的资源使用情况</font><font style="vertical-align: inherit;">：</font></font><a href="/pine-script-docs/concepts/other-timeframes-and-data#tuples"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">expression</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="7n7"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;`request.*()`&nbsp;calls&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;symbol&nbsp;to&nbsp;request&nbsp;data&nbsp;from.</span></span><br><span><span class="mtk18 mtkb">string</span><span class="mtk1">&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.symbol</span><span class="mtk13">(</span><span class="mtk29">"BINANCE:BTCUSDT"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Symbol"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Request&nbsp;9&nbsp;`ta.percentrank()`&nbsp;values&nbsp;from&nbsp;the&nbsp;`s</span><span class="mtk9">ymbolInput`&nbsp;context&nbsp;using&nbsp;a&nbsp;single&nbsp;`request.securi</span><span class="mtk9">ty()`&nbsp;call.</span></span><br><span><span class="mtk13">[</span><span class="mtk33">reqRank1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank3</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank4</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank6</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank7</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank8</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">reqRank9</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk16">request.security</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">symbolInput</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">timeframe.period</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">40</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">50</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">60</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">80</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentrank</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">90</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`reqRank*`&nbsp;values.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank1</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank2</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank3</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank4</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank5</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank6</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank7</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank8</span><span class="mtk13">)</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">reqRank9</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正如我们在下面看到的，
</font><font style="vertical-align: inherit;">运行此版本脚本的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果显示，这次花费了 228.3 毫秒，比上次运行有了很大的改进：</font></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-request-calls-2.BZ75zb8R_Z21D1UV.webp" alt="图像" width="1072" height="486" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本可用的计算资源会随时间</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">波动</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。因此，
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#repetitive-profiling"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析脚本有助于巩固性能结论，这通常是一个好主意。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一种通过一次调用从同一上下文请求多个值的方法</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是将
</font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;">用户定义类型 (UDT)</font></a><font style="vertical-align: inherit;">的
</font></font><a href="/pine-script-docs/language/objects"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为</font><font style="vertical-align: inherit;">参数传递。请参阅
</font><a href="/pine-script-docs/concepts/other-timeframes-and-data"><font style="vertical-align: inherit;">其他时间范围和数据</font></a><font style="vertical-align: inherit;">页面的
</font><a href="/pine-script-docs/concepts/other-timeframes-and-data#user-defined-types"><font style="vertical-align: inherit;">此部分</font></a><font style="vertical-align: inherit;">，了解有关请求
</font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;">UDT 的</font></a><font style="vertical-align: inherit;">更多信息。</font></font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">expression</code><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/other-timeframes-and-data#user-defined-types"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/other-timeframes-and-data"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序员还可以
</font><font style="vertical-align: inherit;">
通过向函数的参数传递实参来减少</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
 </font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.security_lower_tf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.security_lower_tf()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_request.seed"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request.seed()</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">calc_bars_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用的总运行时间
，这</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会限制</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它可以从上下文访问并执行所需计算的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历史</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据点的数量。通常，如果对这些</font></font><code dir="auto">request.*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数的调用检索的历史数据</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多于</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所需的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据，则限制请求</font></font><code dir="auto">calc_bars_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以帮助提高脚本的性能。</font></font></li>
</ul>
<h3 id="avoiding-redrawing" class="md-heading"><a href="#avoiding-redrawing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">避免</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重绘</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™ 的
</font></font><a href="/pine-script-docs/language/type-system#drawing-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图类型</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许脚本在图表上绘制自定义视觉效果，而这是通过其他输出（例如
</font></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）无法实现的。虽然这些类型提供了更大的视觉灵活性，但它们的运行时间和内存成本也</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更高</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，尤其是当脚本不必要地</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新创建</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
绘图而不是直接更新其属性以更改其外观时。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大多数
</font></font><a href="/pine-script-docs/language/type-system#drawing-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图类型（</font></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/lines-and-boxes#polylines"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">折线</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">除外
</font><font style="vertical-align: inherit;">）的命名空间中都具有内置的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置器函数</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，允许脚本修改绘图</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而无需删除并重新创建绘图。当仅</font></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定属性</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要修改时，使用这些设置器通常比创建新绘图对象所需的计算成本更低</font><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，下面的脚本将删除和重新绘制
</font></font><a href="/pine-script-docs/concepts/lines-and-boxes#boxes"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">框</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与使用
</font></font><code dir="auto">box.set*()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数进行比较。在第一个栏上，它声明</font></font><code dir="auto">redrawnBoxes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
和</font></font><a href="/pine-script-docs/language/arrays"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedBoxes</font></font><code dir="auto"> </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并执行</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以将 25 个</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_box"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">框</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
元素推送到其中。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该脚本使用单独的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环遍历</font></font><a href="/pine-script-docs/language/arrays"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并在每次执行时更新绘图。它</font><font style="vertical-align: inherit;">使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.delete"><font style="vertical-align: inherit;">box.delete()</font></a><font style="vertical-align: inherit;">
和
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.new"><font style="vertical-align: inherit;">box.new()</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新创建</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组中的</font><font style="vertical-align: inherit;">
框</font></font><a href="/pine-script-docs/concepts/lines-and-boxes#boxes"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而</font><font style="vertical-align: inherit;">使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_lefttop"><font style="vertical-align: inherit;">box.set_lefttop()</font></a><font style="vertical-align: inherit;">
和
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_rightbottom"><font style="vertical-align: inherit;">box.set_rightbottom()</font></a><em><font style="vertical-align: inherit;">直接修改</font></em><font style="vertical-align: inherit;">数组中
</font><a href="/pine-script-docs/concepts/lines-and-boxes#boxes"><font style="vertical-align: inherit;">框</font></a><font style="vertical-align: inherit;">的属性
</font><font style="vertical-align: inherit;">。两种方法都实现了相同的视觉效果。但是，后者效率更高：</font></font><code dir="auto">redrawnBoxes</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.delete"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.new"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/lines-and-boxes#boxes"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">updatedBoxes</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_lefttop"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_rightbottom"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="4dg"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Avoiding&nbsp;redrawing&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;`box`&nbsp;IDs&nbsp;deleted&nbsp;with&nbsp;`box.delete()`</span><span class="mtk9">&nbsp;and&nbsp;redrawn&nbsp;with&nbsp;`box.new()`&nbsp;on&nbsp;each&nbsp;execution.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBoxes</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;`box`&nbsp;IDs&nbsp;with&nbsp;properties&nbsp;that&nbsp;update</span><span class="mtk9">&nbsp;across&nbsp;executions&nbsp;update&nbsp;via&nbsp;`box.set*()`&nbsp;functio</span><span class="mtk9">ns.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBoxes</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">box</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Populate&nbsp;both&nbsp;arrays&nbsp;with&nbsp;25&nbsp;elements&nbsp;on&nbsp;the&nbsp;fi</span><span class="mtk9">rst&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">redrawnBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">box</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">updatedBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">box.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span></span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">24</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;coordinates.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Get&nbsp;the&nbsp;`box`&nbsp;ID&nbsp;from&nbsp;each&nbsp;array&nbsp;at&nbsp;the&nbsp;`i`&nbsp;ind</span><span class="mtk9">ex.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">box</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBoxes</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">box</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">updatedBoxes</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Delete&nbsp;the&nbsp;`redrawnBox`,&nbsp;create&nbsp;a&nbsp;new&nbsp;`box`&nbsp;ID,</span><span class="mtk9">&nbsp;and&nbsp;replace&nbsp;that&nbsp;element&nbsp;in&nbsp;the&nbsp;`redrawnboxes`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.delete</span><span class="mtk13">(</span><span class="mtk33">redrawnBox</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">box.new</span><span class="mtk13">(</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.set</span><span class="mtk13">(</span><span class="mtk33">redrawnBoxes</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">redrawnBox</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;properties&nbsp;of&nbsp;the&nbsp;`updatedBox`&nbsp;rathe</span><span class="mtk9">r&nbsp;than&nbsp;redrawing&nbsp;it.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.set_lefttop</span><span class="mtk13">(</span><span class="mtk33">updatedBox</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">y</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">box.set_rightbottom</span><span class="mtk13">(</span><span class="mtk33">updatedBox</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">x</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对该脚本进行性能分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的结果
</font><font style="vertical-align: inherit;">显示，包含
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.new"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">box.new()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用的第 24 行是</font><font style="vertical-align: inherit;">每个条形图上执行的
</font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;">代码</font></a><font style="vertical-align: inherit;">块中
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最繁重的行，其运行时间接近第 27 行和第 28 行上</font></font></em><font style="vertical-align: inherit;"><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_lefttop"><font style="vertical-align: inherit;">box.set_lefttop()</font></a><font style="vertical-align: inherit;">
和
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_rightbottom"><font style="vertical-align: inherit;">box.set_rightbottom()</font></a><font style="vertical-align: inherit;">调用所花费时间总和
的</font><strong><font style="vertical-align: inherit;">两倍</font></strong><font style="vertical-align: inherit;">
：</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_lefttop"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_box.set_rightbottom"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Avoiding-redrawing-1.CVCJc2lm_ZJcTqr.webp" alt="图像" width="1072" height="514" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环本地代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示的执行次数</font><font style="vertical-align: inherit;">是脚本</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全局范围</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内代码显示次数的 25 倍，因为每次执行循环语句都会触发 25 次本地块的执行。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此脚本会更新</font><font style="vertical-align: inherit;">图表历史记录中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有条形图的绘图，以用于</font></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目的。但是，它实际上</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并不</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
需要执行所有这些历史更新，因为用户只会看到</font><em><font style="vertical-align: inherit;">最后一个历史条形图的</font></em></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最终</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果和</font><em><font style="vertical-align: inherit;">实时条形图</font></em><font style="vertical-align: inherit;">的变化</font><font style="vertical-align: inherit;">。请参阅
</font><a href="/pine-script-docs/writing/profiling-and-optimization#reducing-drawing-updates"><font style="vertical-align: inherit;">下一节</font></a><font style="vertical-align: inherit;">以了解更多信息。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#reducing-drawing-updates"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
</ul>
<h3 id="reducing-drawing-updates" class="md-heading"><a href="#reducing-drawing-updates"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少图纸</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本生成
随</font><em><font style="vertical-align: inherit;">历史条形图</font></em><font style="vertical-align: inherit;">变化的</font></font><a href="/pine-script-docs/language/type-system#drawing-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图对象</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时，用户只能在这些条形图上看到</font><strong><font style="vertical-align: inherit;">最终结果</font></strong><font style="vertical-align: inherit;">，因为脚本在首次加载到图表上时就完成了其历史执行。只有在</font><em><font style="vertical-align: inherit;">实时条形图</font></em><font style="vertical-align: inherit;">期间，随着新数据的流入，才能看到此类绘图</font><font style="vertical-align: inherit;">随执行
</font><em><font style="vertical-align: inherit;">而变化。</font></em></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于用户</font><strong><font style="vertical-align: inherit;">永远看不到</font></strong><font style="vertical-align: inherit;">历史条形图上动态</font></font><a href="/pine-script-docs/language/type-system#drawing-types"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘图</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的不断变化的输出
，因此通常可以通过</font><em><font style="vertical-align: inherit;">消除</font></em><font style="vertical-align: inherit;">不影响最终结果的历史更新来提高脚本的性能。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，此脚本创建一个
</font><font style="vertical-align: inherit;">
包含两列和 21 行的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_table"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以
分页表格格式
可视化</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_ta.rsi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSI</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">infoTable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的历史记录。该脚本初始化第一条</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.isfirst"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">柱上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的单元格，并引用计算的历史记录</font></font><code dir="auto">rsi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来更新
</font></font><code dir="auto">text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每条柱上的</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;">for</font></a></font><code dir="auto">bgcolor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环内第二列单元格的单元
格</font><font style="vertical-align: inherit;">：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="1sl"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;drawing&nbsp;updates&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;first&nbsp;offset&nbsp;shown&nbsp;in&nbsp;the&nbsp;paginated&nbsp;table.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Page"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">249</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;table&nbsp;that&nbsp;shows&nbsp;the&nbsp;history&nbsp;of&nbsp;RSI&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">table</span><span class="mtk1">&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">table.new</span><span class="mtk13">(</span><span class="mtk11">position.top_right</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">21</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_width</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Initialize&nbsp;the&nbsp;table's&nbsp;cells&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Offset"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.rsi</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">14</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;history&nbsp;shown&nbsp;in&nbsp;the&nbsp;`infoTable`&nbsp;on&nbsp;</span><span class="mtk9">each&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">historicalRSI</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk13">[</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_text</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_bgcolor</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rsi</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对脚本进行性能分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后
</font><font style="vertical-align: inherit;">，我们发现对性能影响最大的代码是
从第 20 行开始的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环，即
</font><font style="vertical-align: inherit;">更新表格单元格的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码块：</font></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-drawing-updates-1.DGjGYc9o_Z2h4bJz.webp" alt="图像" width="1072" height="494" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此关键代码区域</font><font style="vertical-align: inherit;">在图表的历史记录中
执行</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过多，因为用户只能看到</font></font></strong><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/tables"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格的</font></font></a> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最终</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
历史结果。用户唯一能看到
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_table"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表格</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新的时间是在</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后一个历史条形图</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上以及所有后续
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实时条形图上。因此，我们可以将此代码的执行限制在</font></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.islast"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后一个可用条形图</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上，从而优化此脚本的资源使用情况</font><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此脚本版本中，我们将
</font><font style="vertical-align: inherit;">更新
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_table"><font style="vertical-align: inherit;">表格单元格的</font></a></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">放在
使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.islast"><font style="vertical-align: inherit;">barstate.islast</font></a><font style="vertical-align: inherit;">
作为条件的
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;">if</font></a><font style="vertical-align: inherit;">结构
中
，从而有效地将代码块的执行限制为仅最后一个历史条和所有实时条。现在，脚本</font><em><font style="vertical-align: inherit;">加载</font></em><font style="vertical-align: inherit;">效率更高，因为所有表格的计算只需要</font><strong><font style="vertical-align: inherit;">一次</font></strong><font style="vertical-align: inherit;">历史执行：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_table"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_if"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.islast"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Reducing-drawing-updates-2.DVDSH-lG_Z1AqBk6.webp" alt="图像" width="1072" height="520" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="7c6"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;drawing&nbsp;updates&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;first&nbsp;offset&nbsp;shown&nbsp;in&nbsp;the&nbsp;paginated&nbsp;table.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Page"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">249</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk12">20</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;table&nbsp;that&nbsp;shows&nbsp;the&nbsp;history&nbsp;of&nbsp;RSI&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">table</span><span class="mtk1">&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">table.new</span><span class="mtk13">(</span><span class="mtk11">position.top_right</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">2</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">21</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">border_width</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Initialize&nbsp;the&nbsp;table's&nbsp;cells&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Offset"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">text_color</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">chart.fg_color</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.rsi</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">14</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Update&nbsp;the&nbsp;history&nbsp;shown&nbsp;in&nbsp;the&nbsp;`infoTable`&nbsp;on&nbsp;</span><span class="mtk9">the&nbsp;last&nbsp;available&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">19</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">historicalRSI</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">rsi</span><span class="mtk13">[</span><span class="mtk33">offsetInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_text</span><span class="mtk13">(</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">str.tostring</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">table.cell_set_bgcolor</span><span class="mtk13">(</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">infoTable</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">color.from_gradient</span><span class="mtk13">(</span><span class="mtk33">historicalRSI</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">30</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">70</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.red</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.green</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rsi</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"RSI"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当新的实时</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新出现</font><font style="vertical-align: inherit;">时，脚本仍会更新单元格，因为用户可以在图表上观察到这些变化，这与脚本在历史条上执行的变化不同。</font></font></li>
</ul>
<h3 id="storing-calculated-values" class="md-heading"><a href="#storing-calculated-values"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储计算</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本执行关键计算且
在整个执行过程中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">很少</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发生变化时，可以通过
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将结果保存到使用</font></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_var"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_varip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">varip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关键字声明的变量中
</font><font style="vertical-align: inherit;">
并</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在计算发生变化时更新该值来减少其运行时间。如果脚本计算</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多个</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值过多，则可以将它们存储在
</font></font><a href="/pine-script-docs/language/type-system#collections"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集合</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
</font></font><a href="/pine-script-docs/language/matrices"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">矩阵</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、
</font></font><a href="/pine-script-docs/language/maps"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">映射</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或
</font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;">用户定义类型</font></a><font style="vertical-align: inherit;">的
</font></font><a href="/pine-script-docs/language/objects"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中。</font></font><a href="/pine-script-docs/language/type-system#user-defined-types"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一个例子。此脚本根据广义</font></font><a href="https://en.wikipedia.org/wiki/Window_function" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">窗口函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算具有自定义权重的加权移动平均值。
是加权</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;">收盘</font></a></font><code dir="auto">numerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">价的总和
</font><font style="vertical-align: inherit;">
，是</font><font style="vertical-align: inherit;">计算出的权重的总和。该脚本使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;">for</font></a><font style="vertical-align: inherit;">循环迭代</font><font style="vertical-align: inherit;">多次来计算这些总和，然后绘制它们的比率，即最终的平均值：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">denominator</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="5e0"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Storing&nbsp;calculated&nbsp;values&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;weighted&nbsp;average&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5000</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Window&nbsp;coefficient.&nbsp;</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Window&nbsp;coefficient"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.01</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weighted&nbsp;`close`&nbsp;prices.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weights.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;angular&nbsp;step&nbsp;in&nbsp;the&nbsp;cosine&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">math.pi</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span class="mtk9">//&nbsp;Accumulate&nbsp;weighted&nbsp;sums.</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.cos</span><span class="mtk13">(</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;weighted&nbsp;average&nbsp;result.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Weighted&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
根据我们的图表数据对脚本的性能</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之后，我们发现，计算 20,155 个图表更新的默认 50 条平均值大约需要 241.3 毫秒，而
</font><font style="vertical-align: inherit;">对脚本性能
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响最大的关键代码是从第 17 行开始的循环</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#code-block-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">块</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-1.Db6QOvTY_1SK8Tz.webp" alt="图像" width="1072" height="424" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于循环迭代次数</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取决于</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值，让我们测试一下它的运行时间如何与
需要更重循环的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-across-configurations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一个配置</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一起扩展。在这里，我们将值设置为 2500。这次，脚本大约需要 12 秒才能完成所有执行：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-2.DsxEbDvA_DT4zd.webp" alt="图像" width="1072" height="424" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在我们已经确定了脚本中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影响最大的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码，并建立了改进基准，我们可以检查关键代码块以识别优化机会。检查计算后，我们可以观察到以下内容：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"></font><code dir="auto">weight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导致第 18 行的计算在循环迭代中发生变化的</font><font style="vertical-align: inherit;">唯一值是</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环索引</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。其计算中的所有其他值保持一致。因此，</font></font><code dir="auto">weight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每次循环迭代计算的在图表条形图中</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会发生变化。因此，我们不必在</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每次更新</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时都计算权重</font><font style="vertical-align: inherit;">，而是可以在第一个条形图上计算</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将它们存储在</font></font></strong><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/type-system#collections"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集合</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中
</font><font style="vertical-align: inherit;">，以便在后续脚本执行中访问。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于权重永远不会改变，结果也</font></font><code dir="auto">denominator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">永远不会改变。因此，我们可以
</font><font style="vertical-align: inherit;">
在
</font><a href="/pine-script-docs/language/variable-declarations"><font style="vertical-align: inherit;">变量声明中添加</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_var"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var关键字，并只计算</font></font></a><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">一次</font></strong><font style="vertical-align: inherit;">其值，以减少执行</font><a href="https://www.tradingview.com/pine-script-reference/v5/#op_+="><font style="vertical-align: inherit;">加法赋值</font></a><font style="vertical-align: inherit;">运算的次数</font><font style="vertical-align: inherit;">
。</font></font><a href="/pine-script-docs/language/variable-declarations"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#op_+="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与 不同</font></font><code dir="auto">denominator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储该</font></font><code dir="auto">numerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值以简化其计算，因为它会随着时间的推移不断</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变化</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在下面修改后的脚本中，我们添加了一个</font></font><code dir="auto">weights</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量来引用
</font><font style="vertical-align: inherit;">
存储每个计算的 的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">weight</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。此变量和 都
在其声明中</font></font><code dir="auto">denominator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_var"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关键字，这意味着分配给它们的值将
在整个脚本执行过程中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保持不变</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，直到明确重新分配。该脚本使用
</font><font style="vertical-align: inherit;">仅在</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.isfirst"><font style="vertical-align: inherit;">第一个图表条上执行的</font></a></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环来计算它们的值。在所有其他条中，它</font><font style="vertical-align: inherit;">使用
引用数组</font><font style="vertical-align: inherit;">中</font><em><font style="vertical-align: inherit;">保存的值的</font></em><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;">for…in</font></a><font style="vertical-align: inherit;">
循环来计算</font><font style="vertical-align: inherit;">：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.isfirst"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">numerator</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><code dir="auto">weights</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="5a0"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Storing&nbsp;calculated&nbsp;values&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;weighted&nbsp;average&nbsp;calcul</span><span class="mtk9">ation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">50</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">5000</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;Window&nbsp;coefficient.&nbsp;</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.float</span><span class="mtk13">(</span><span class="mtk12">0.5</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Window&nbsp;coefficient"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.01</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;that&nbsp;stores&nbsp;the&nbsp;`weight`&nbsp;values&nbsp;calculat</span><span class="mtk9">ed&nbsp;on&nbsp;the&nbsp;first&nbsp;chart&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">weights</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weighted&nbsp;`close`&nbsp;prices.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;sum&nbsp;of&nbsp;weights.&nbsp;The&nbsp;script&nbsp;now&nbsp;only&nbsp;calculate</span><span class="mtk9">s&nbsp;this&nbsp;value&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.&nbsp;</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;angular&nbsp;step&nbsp;in&nbsp;the&nbsp;cosine&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">2.0</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk11">math.pi</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Populate&nbsp;the&nbsp;`weights`&nbsp;array&nbsp;and&nbsp;calculate&nbsp;the&nbsp;</span><span class="mtk9">`denominator`&nbsp;only&nbsp;on&nbsp;the&nbsp;first&nbsp;bar.</span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.isfirst</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">coefInput</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.cos</span><span class="mtk13">(</span><span class="mtk33">step</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">array.push</span><span class="mtk13">(</span><span class="mtk33">weights</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">weight</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;`numerator`&nbsp;on&nbsp;each&nbsp;bar&nbsp;using&nbsp;the</span><span class="mtk9">&nbsp;stored&nbsp;`weights`.&nbsp;</span></span><br><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">w</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">weights</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">w</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;weighted&nbsp;average&nbsp;result.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Weighted&nbsp;average"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">color.purple</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">3</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过这种优化的结构，
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示，我们修改后的脚本在高</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值为 2500 的情况下，对相同数据的计算大约需要 5.9 秒，大约是</font><font style="vertical-align: inherit;">之前版本时间的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一半：</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Storing-calculated-values-3.k6QQwb-Z_ZqmRWt.webp" alt="图像" width="1072" height="566" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽管我们通过将其</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行不变的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值保存到变量中显著提高了此脚本的性能，但由于在每个条上执行的剩余循环计算，它在</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大</font></font></strong> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值的情况下仍然涉及更高的计算成本。</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一种更</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高级的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法是，将权重存储在
</font><font style="vertical-align: inherit;">
第一条柱上的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单行</font></font></em>
<a href="https://www.tradingview.com/pine-script-reference/v5/#type_matrix"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">矩阵中，使用</font></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为
</font></font><a href="/pine-script-docs/language/arrays#using-an-array-as-aqueue"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">队列</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来保存最近的
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收盘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
价，然后用
对</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_matrix.mult"><font style="vertical-align: inherit;">matrix.mult()</font></a><font style="vertical-align: inherit;">
的调用
替换</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for…in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环。请参阅</font><a href="/pine-script-docs/language/matrices"><font style="vertical-align: inherit;">矩阵</font></a><font style="vertical-align: inherit;">
页面以了解有关使用</font><font style="vertical-align: inherit;">函数的更多信息。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_matrix.mult"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/matrices"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">matrix.*()</code><font style="vertical-align: inherit;"></font></li>
</ul>
<h3 id="eliminating-loops" class="md-heading"><a href="#eliminating-loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消除</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">环路</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许 Pine 脚本在每次执行时进行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迭代</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算。每次激活循环时，其本地代码可能会执行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这通常会导致</font><font style="vertical-align: inherit;">资源使用量</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大幅增加。</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine 循环对于</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">某些</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算是必需的，例如操作
</font></font><a href="/pine-script-docs/language/type-system#collections"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集合</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中的元素或回顾数据集的历史记录以计算</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在当前栏上可获得的值。然而，在许多其他情况下，程序员在</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不需要</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时使用循环，导致运行时性能不佳。在这种情况下，可以根据计算内容通过以下任何一种方式消除不必要的循环：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">识别</font><font style="vertical-align: inherit;">无需迭代即可实现相同结果的简化、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无循环表达式</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽可能使用优化的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#using-built-ins"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内置函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换循环
</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在可行的情况下将循环迭代分散</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到各个条形中，</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而不是一次性评估所有条形</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这个简单的例子包含一个</font></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，用于计算当前柱线</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值与之前柱线所有值之间的平均差值</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。脚本调用此函数来计算当前
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收盘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
价与</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前价格之间的平均差值，然后将
结果</font></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绘制</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在图表上：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3yb"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Eliminating&nbsp;loops&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">20</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;average&nbsp;difference&nbsp;between&nbsp;the&nbsp;cur</span><span class="mtk9">rent&nbsp;`source`&nbsp;and&nbsp;`length`&nbsp;previous&nbsp;`source`&nbsp;value</span><span class="mtk9">s.</span></span><br><span><span class="mtk15">avgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">avgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在使用默认设置检查脚本的
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后，我们发现执行 20,157 次大约需要 64 毫秒：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-1.CagHTlaL_Z1XidNw.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于我们在调用</font><font style="vertical-align: inherit;">中
使用了</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为参数</font><font style="vertical-align: inherit;">，并且该参数控制函数内部循环必须迭代的次数，因此我们的脚本的运行时间将
</font><font style="vertical-align: inherit;">随着值的</font><strong><font style="vertical-align: inherit;">增长而增长</font></strong><font style="vertical-align: inherit;">。在这里，我们在脚本的设置中将输入的值设置为 2000。这次，脚本在大约 3.8 秒内完成了执行：</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-2.GHOgXfCo_Z2hwC8b.webp" alt="图像" width="1072" height="304" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从这些结果中我们可以看出，</font><font style="vertical-align: inherit;">由于函数</font><font style="vertical-align: inherit;">
在每个柱上执行
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;">for</font></a></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环，因此调用该函数的成本可能很高，具体取决于指定的值。但是，</font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;">循环</font></a><font style="vertical-align: inherit;">对于实现输出来说并不是</font><strong><font style="vertical-align: inherit;">必需</font></strong><font style="vertical-align: inherit;">的。为了理解原因，让我们仔细看看循环的计算。我们可以用以下表达式表示它们：</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="6o6"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;...&nbsp;+&nbsp;(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">])</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，它将</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前</font></font></em> <code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值乘以</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。这些迭代加法不是必需的。我们可以将表达式的该部分简化为</font></font><code dir="auto">source * length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，从而将其简化为以下内容：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="ja"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;...&nbsp;-&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">]</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或者等价地：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3oj"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">1</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk12">2</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;...&nbsp;+&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">length</span><span class="mtk13">])</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简化并重新排列循环计算的表示后，我们发现，我们可以用更简单的方式计算结果，并
通过</font><font style="vertical-align: inherit;">从值中减去前一个条形的</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_math.sum"><font style="vertical-align: inherit;">滚动值总和</font></a><font style="vertical-align: inherit;">
来</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消除</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font><font style="vertical-align: inherit;">，即：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_math.sum"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">source</code><font style="vertical-align: inherit;"></font><code dir="auto">source * length</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="1e"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">]</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下面的函数</font></font><code dir="auto">fastAvgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">原始函数的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无循环</font></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替代，它使用上面的表达式来计算差异的总和</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后将表达式除以</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回平均差异：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="6fo"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;way&nbsp;to&nbsp;calculate&nbsp;the&nbsp;`avgDifference()`&nbsp;r</span><span class="mtk9">esult.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eliminates&nbsp;the&nbsp;`for`&nbsp;loop&nbsp;using&nbsp;the&nbsp;re</span><span class="mtk9">lationship:&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`(x&nbsp;-&nbsp;x[1])&nbsp;+&nbsp;(x&nbsp;-&nbsp;x[2])&nbsp;+&nbsp;...&nbsp;+&nbsp;(x&nbsp;-&nbsp;</span><span class="mtk9">x[n])&nbsp;=&nbsp;x&nbsp;*&nbsp;n&nbsp;-&nbsp;math.sum(x,&nbsp;n)[1]`.</span></span><br><span><span class="mtk15">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在我们已经确定了一个潜在的优化解决方案，我们可以将 的性能</font></font><code dir="auto">fastAvgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与原始
</font></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数进行比较。下面的脚本是以前版本的修改形式，它绘制了使用 作为参数调用两个函数的</font></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="3n3"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Eliminating&nbsp;loops&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;number&nbsp;of&nbsp;bars&nbsp;in&nbsp;the&nbsp;calculation.</span></span><br><span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">input.int</span><span class="mtk13">(</span><span class="mtk12">20</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Length"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;average&nbsp;difference&nbsp;between&nbsp;the&nbsp;cur</span><span class="mtk9">rent&nbsp;`source`&nbsp;and&nbsp;`length`&nbsp;previous&nbsp;`source`&nbsp;value</span><span class="mtk9">s.</span></span><br><span><span class="mtk15">avgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">diffSum</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;A&nbsp;faster&nbsp;way&nbsp;to&nbsp;calculate&nbsp;the&nbsp;`avgDifference()`&nbsp;r</span><span class="mtk9">esult.&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Eliminates&nbsp;the&nbsp;`for`&nbsp;loop&nbsp;using&nbsp;the&nbsp;re</span><span class="mtk9">lationship:&nbsp;</span></span><br><span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`(x&nbsp;-&nbsp;x[1])&nbsp;+&nbsp;(x&nbsp;-&nbsp;x[2])&nbsp;+&nbsp;...&nbsp;+&nbsp;(x&nbsp;-&nbsp;</span><span class="mtk9">x[n])&nbsp;=&nbsp;x&nbsp;*&nbsp;n&nbsp;-&nbsp;math.sum(x,&nbsp;n)[1]`.</span></span><br><span><span class="mtk15">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.sum</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk13">)[</span><span class="mtk12">1</span><span class="mtk13">])</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">avgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">fastAvgDifference</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">lengthInput</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本的默认设置是 20，</font><font style="vertical-align: inherit;">分析
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></a><font style="vertical-align: inherit;"></font><code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示两次函数调用的运行时间存在显著差异。原始函数的调用在这次运行中执行了 20,157 次，耗时约 47.3 毫秒，而我们优化后的函数仅耗时 4.5 毫秒：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-3.DiuPpBDh_1dyGfx.webp" alt="图像" width="1072" height="410" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，让我们将性能与2000 这个</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更大的</font></font></em> <code dir="auto">lengthInput</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值进行比较。与以前一样，</font></font><code dir="auto">avgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数所花费的运行时间显著增加。但是，执行调用所花费的时间
</font></font><code dir="auto">fastAvgDifference()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍然非常接近以前
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-across-configurations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果。换句话说，虽然我们原始函数的运行时间与其</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数直接相关，但我们优化的函数表现出相对</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一致的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">性能，因为它不需要循环：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Eliminating-loops-4.V8AwhZcD_23XFmP.webp" alt="图像" width="1072" height="410" loading="lazy" decoding="async"></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并非所有迭代计算都必然具有无循环替代方案。如果脚本只能</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迭代实现其结果，程序员可以找出优化循环以提高性能的可能方法。
</font><font style="vertical-align: inherit;">有关更多信息，请参阅</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#optimizing-loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一节。</font></font></a><font style="vertical-align: inherit;"></font></p></div></aside>
<h3 id="optimizing-loops" class="md-heading"><a href="#optimizing-loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽管 Pine 的
</font></font><a href="/pine-script-docs/language/execution-model"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行模型</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和可用的内置函数通常在许多情况下</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消除了对</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的需要
</font><font style="vertical-align: inherit;">，但在某些情况下脚本仍</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环来
</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">某些类型的任务，包括：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当可用的内置函数</font><strong><font style="vertical-align: inherit;">不够</font></strong><font style="vertical-align: inherit;">用时，</font><font style="vertical-align: inherit;">操作
</font></font><a href="/pine-script-docs/language/type-system#collections"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集合或对集合的元素执行计算</font></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行跨历史条形图的计算，这是</font><font style="vertical-align: inherit;">
使用简化的</font><em><font style="vertical-align: inherit;">无循环</font></em><font style="vertical-align: inherit;">表达式或优化的
</font><em><font style="vertical-align: inherit;">内置函数</font></em></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法实现的</font></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em></li>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算只能</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过迭代获得的</font><font style="vertical-align: inherit;">值</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本使用</font><font style="vertical-align: inherit;">
程序员无法
</font><a href="/pine-script-docs/writing/profiling-and-optimization#eliminating-loops"><font style="vertical-align: inherit;">消除的</font></a></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时，可以使用</font><a href="https://en.wikipedia.org/wiki/Loop_optimization" rel="nofollow"><font style="vertical-align: inherit;">多种技术</font></a><font style="vertical-align: inherit;">来减少其对性能的影响。本节介绍两种最常见、最有用的技术，它们可以帮助提高所需循环的效率。</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#eliminating-loops"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://en.wikipedia.org/wiki/Loop_optimization" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在确定优化</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环的方法之前</font><font style="vertical-align: inherit;">，我们建议先寻找
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#eliminating-loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消除</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环的方法。如果</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有解决方案</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以使循环变得不必要，那么继续尝试减少其开销。</font></font></p></div></aside>
<h4 id="reducing-loop-calculations" class="md-heading"><a href="#reducing-loop-calculations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少循环</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在循环的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">局部范围</font><font style="vertical-align: inherit;">内执行的代码可能会</font><font style="vertical-align: inherit;">对其整体运行时间产生</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">倍增影响，因为每次执行循环语句时，它通常会触发局部代码的</font></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迭代。因此，程序员应努力通过消除不必要的结构、函数调用和操作来使循环的计算尽可能简单，以最大限度地降低性能影响，尤其是当脚本必须在所有执行</font><font style="vertical-align: inherit;">过程中</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次评估其循环时。</font></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，此脚本包含一个函数，该函数</font><font style="vertical-align: inherit;">根据</font><font style="vertical-align: inherit;">指定</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a></font><code dir="auto">filteredMA()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中的元素计算最多</font></font><code dir="auto">length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">唯一值的移动平均值</font><font style="vertical-align: inherit;">。该函数将唯一</font><font style="vertical-align: inherit;">值排队到</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a><font style="vertical-align: inherit;">中，使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;">for…in</font></a><font style="vertical-align: inherit;">
循环迭代</font><font style="vertical-align: inherit;">并计算和</font><font style="vertical-align: inherit;">总和
</font><font style="vertical-align: inherit;">，然后返回这些总和的比率。在循环中，只有当元素</font><font style="vertical-align: inherit;">不是
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_na"><font style="vertical-align: inherit;">na</font></a><font style="vertical-align: inherit;">且</font><font style="vertical-align: inherit;">元素为时</font><font style="vertical-align: inherit;">，它才会将值添加到总和中</font><font style="vertical-align: inherit;">。该脚本利用此
</font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;">用户定义函数</font></a><font style="vertical-align: inherit;">计算
按 a 过滤的最多 100 个唯一</font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;">收盘</font></a><font style="vertical-align: inherit;">价的平均值
</font><font style="vertical-align: inherit;">，并在图表上绘制结果：</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"></font><code dir="auto">true</code><font style="vertical-align: inherit;"></font><code dir="auto">mask</code>
<a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">source</code><font style="vertical-align: inherit;"></font><code dir="auto">data</code>
<a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">data</code><font style="vertical-align: inherit;"></font><code dir="auto">numerator</code><font style="vertical-align: inherit;"></font><code dir="auto">denominator</code><font style="vertical-align: inherit;"></font><code dir="auto">data</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_na"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">mask</code><font style="vertical-align: inherit;"></font><code dir="auto">index</code><font style="vertical-align: inherit;"></font><code dir="auto">true</code><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/user-defined-functions"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_close"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">randMask</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="6e8"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;loop&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;a&nbsp;moving&nbsp;average&nbsp;of&nbsp;up&nbsp;to&nbsp;`length`&nbsp;uni</span><span class="mtk9">que&nbsp;`source`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;a&nbsp;`mask`&nbsp;array.</span></span><br><span><span class="mtk15">filteredMA</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Raise&nbsp;a&nbsp;runtime&nbsp;error&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`</span><span class="mtk9">&nbsp;doesn't&nbsp;equal&nbsp;the&nbsp;`length`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">size</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">runtime.error</span><span class="mtk13">(</span><span class="mtk29">"The&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`&nbsp;array&nbsp;used&nbsp;in&nbsp;the&nbsp;`filtere</span><span class="mtk29">dMA()`&nbsp;call&nbsp;must&nbsp;match&nbsp;the&nbsp;`length`."</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;`length`&nbsp;unique&nbsp;`source`&nbsp;valu</span><span class="mtk9">es.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Queue&nbsp;unique&nbsp;`source`&nbsp;values&nbsp;into&nbsp;the&nbsp;`data`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">not</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">includes</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;The&nbsp;numerator&nbsp;and&nbsp;denominator&nbsp;of&nbsp;the&nbsp;average.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;calculate&nbsp;sums.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.indexof</span><span class="mtk13">(</span><span class="mtk33">data</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;average,&nbsp;or&nbsp;the&nbsp;last&nbsp;non-`na`&nbsp;averag</span><span class="mtk9">e&nbsp;value&nbsp;if&nbsp;the&nbsp;current&nbsp;value&nbsp;is&nbsp;`na`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">fixnan</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;100&nbsp;pseudorandom&nbsp;"bool"&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;the&nbsp;first&nbsp;element&nbsp;from&nbsp;`randMask`&nbsp;to&nbsp;the&nbsp;e</span><span class="mtk9">nd&nbsp;and&nbsp;queue&nbsp;a&nbsp;new&nbsp;pseudorandom&nbsp;value.</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">())</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`filteredMA()`&nbsp;of&nbsp;up&nbsp;to&nbsp;100&nbsp;unique&nbsp;`cl</span><span class="mtk9">ose`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;the&nbsp;`randMask`.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">filteredMA</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对脚本进行性能分析</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后，我们发现执行 21,778 次大约需要两秒钟。对性能影响最大的代码是第 37 行的表达式，该表达式调用了该</font></font><code dir="auto">filteredMA()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数。在</font></font><code dir="auto">filteredMA()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数范围内，
 </font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for…in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环的影响最大，</font></font><code dir="auto">index</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环范围内的计算（第 22 行）对循环运行时间的贡献最大：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Reducing-loop-calculations-1.DATOq5cw_2jUPjt.webp" alt="图像" width="1070" height="684" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上述代码演示了
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for…in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环的次优用法，因为</font><font style="vertical-align: inherit;">在这种情况下
我们</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不需要</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.indexof"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.indexof()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
来检索。在循环中调用</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.indexof"><font style="vertical-align: inherit;">array.indexof()</font></a><font style="vertical-align: inherit;">
函数的成本可能</font><em><font style="vertical-align: inherit;">很高，因为</font></em><em><font style="vertical-align: inherit;">每次</font></em><font style="vertical-align: inherit;">脚本调用它时</font><font style="vertical-align: inherit;">，它都必须搜索</font><a href="/pine-script-docs/language/arrays"><font style="vertical-align: inherit;">数组的</font></a><font style="vertical-align: inherit;">
内容并找到相应元素的索引。</font></font><code dir="auto">index</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.indexof"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/language/arrays"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了消除
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for...in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环中这个代价高昂的调用，我们可以使用</font><font style="vertical-align: inherit;">结构的
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二种形式</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它在每​​次迭代中生成一个包含</font><strong><font style="vertical-align: inherit;">索引</font></strong><font style="vertical-align: inherit;">和元素值的</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元组：</font></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="38q"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此版本的脚本中，我们删除了
第 22 行的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.indexof"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.indexof()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用，因为它</font><font style="vertical-align: inherit;">对于实现预期结果
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不是必需的，并且我们将</font></font></strong><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for...in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环更改为使用替代形式：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="5te"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Reducing&nbsp;loop&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;a&nbsp;moving&nbsp;average&nbsp;of&nbsp;up&nbsp;to&nbsp;`length`&nbsp;uni</span><span class="mtk9">que&nbsp;`source`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;a&nbsp;`mask`&nbsp;array.</span></span><br><span><span class="mtk15">filteredMA</span><span class="mtk13">(</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Raise&nbsp;a&nbsp;runtime&nbsp;error&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`</span><span class="mtk9">&nbsp;doesn't&nbsp;equal&nbsp;the&nbsp;`length`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">size</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">!=</span><span class="mtk1">&nbsp;</span><span class="mtk33">length</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">runtime.error</span><span class="mtk13">(</span><span class="mtk29">"The&nbsp;size&nbsp;of&nbsp;the&nbsp;`mask`&nbsp;array&nbsp;used&nbsp;in&nbsp;the&nbsp;`filtere</span><span class="mtk29">dMA()`&nbsp;call&nbsp;must&nbsp;match&nbsp;the&nbsp;`length`."</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;`length`&nbsp;unique&nbsp;`source`&nbsp;valu</span><span class="mtk9">es.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk33">length</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Queue&nbsp;unique&nbsp;`source`&nbsp;values&nbsp;into&nbsp;the&nbsp;`data`&nbsp;ar</span><span class="mtk9">ray.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk18">not</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">includes</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">data</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;The&nbsp;numerator&nbsp;and&nbsp;denominator&nbsp;of&nbsp;the&nbsp;average.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;calculate&nbsp;sums.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk13">[</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">data</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">item</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">mask</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">denominator</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1.0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;average,&nbsp;or&nbsp;the&nbsp;last&nbsp;non-`na`&nbsp;averag</span><span class="mtk9">e&nbsp;value&nbsp;if&nbsp;the&nbsp;current&nbsp;value&nbsp;is&nbsp;`na`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">fixnan</span><span class="mtk13">(</span><span class="mtk33">numerator</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">denominator</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;100&nbsp;pseudorandom&nbsp;"bool"&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">bool</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Push&nbsp;the&nbsp;first&nbsp;element&nbsp;from&nbsp;`randMask`&nbsp;to&nbsp;the&nbsp;e</span><span class="mtk9">nd&nbsp;and&nbsp;queue&nbsp;a&nbsp;new&nbsp;pseudorandom&nbsp;value.</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">())</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">math.random</span><span class="mtk13">(</span><span class="mtk33">seed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">12345</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">&lt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span></span><br><span><span class="mtk33">randMask</span><span class="mtk1">.</span><span class="mtk15">shift</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;`filteredMA()`&nbsp;of&nbsp;up&nbsp;to&nbsp;100&nbsp;unique&nbsp;`cl</span><span class="mtk9">ose`&nbsp;values&nbsp;filtered&nbsp;by&nbsp;the&nbsp;`randMask`.&nbsp;</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">filteredMA</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">randMask</span><span class="mtk13">))</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过这一简单的更改，我们的循环效率更高，因为它不再需要在每次迭代时重复搜索数组
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
跟踪索引。
此脚本运行的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示，它仅需 0.6 秒即可完成执行，与以前版本的结果相比有显著改进：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Reducing-loop-calculations-2.ChKixPxa_1dGXff.webp" alt="图像" width="1070" height="668" loading="lazy" decoding="async"></p>
<h4 id="loop-invariant-code-motion" class="md-heading"><a href="#loop-invariant-code-motion"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不变代码</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移动</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h4>
<p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不变代码</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是
</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">范围内的任何代码区域，每次迭代都会产生</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不变的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果。当脚本的
</font></font><a href="/pine-script-docs/language/loops"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含循环不变代码时，由于过多、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不必要的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算，在某些情况下可能会严重影响性能。</font></font></p>
<p><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序员可以通过将</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不变的计算移到</font><font style="vertical-align: inherit;">循环范围</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之外来</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化具有不变代码的循环，这样脚本只需在每次执行时评估一次它们，而不是重复评估。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下示例包含一个函数，用于创建</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;">数组</font></a></font><code dir="auto">featureScale()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的重新缩放版本
</font><font style="vertical-align: inherit;">。在函数的
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;">for…in</font></a><font style="vertical-align: inherit;">
循环中，它通过计算每个元素与
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.min"><font style="vertical-align: inherit;">array.min()</font></a><font style="vertical-align: inherit;">的距离
并将值除以
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.range"><font style="vertical-align: inherit;">array.range()</font></a><font style="vertical-align: inherit;">来缩放每个元素。脚本使用此函数创建一个</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">价格</font></a><font style="vertical-align: inherit;">版本
</font><font style="vertical-align: inherit;">
，在图表上</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">绘制</font></a><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.first"><font style="vertical-align: inherit;">rescaled.first()</font></a><font style="vertical-align: inherit;">
和
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.avg"><font style="vertical-align: inherit;">rescaled.avg()</font></a><font style="vertical-align: inherit;">值之间的差异
：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_array"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.min"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.range"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">rescaled</code><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"></font><code dir="auto">array and</code><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.first"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.avg"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="13y"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Loop-invariant&nbsp;code&nbsp;motion&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Returns&nbsp;a&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;`this`&nbsp;array.</span></span><br><span><span class="mtk15">featureScale</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">((</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.min</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">))</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.range</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">prices</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;the&nbsp;`close`&nbsp;through&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">pop</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">featureScale</span><span class="mtk13">(</span><span class="mtk33">prices</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;first&nbsp;element&nbsp;a</span><span class="mtk9">nd&nbsp;the&nbsp;average&nbsp;value&nbsp;in&nbsp;the&nbsp;`rescaled`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">first</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">())</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如下所示，
执行 20,187 次后，此脚本的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示它在大约 3.3 秒内完成运行。对性能影响最大的代码是包含函数</font></font><code dir="auto">featureScale()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用的行，而该函数的关键代码是
从第 7 行开始</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的 for…in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环块：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Loop-invariant-code-motion-1.BAn098-h_10uiO5.webp" alt="图像" width="1072" height="404" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查循环的计算后，我们可以看到
</font><font style="vertical-align: inherit;">
第 8 行的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.min"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.min()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
和
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.range"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array.range()调用是</font></font></a><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不变的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为它们在每次迭代中始终会产生
</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相同的结果。我们可以将这些调用的结果分配给其范围</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之外的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量并根据需要引用它们，从而</font><font style="vertical-align: inherit;">使循环更加高效
。</font></font></p>
<p><font style="vertical-align: inherit;"></font><code dir="auto">featureScale()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下脚本中的函数在执行 for…in 循环之前将 array.min() 和 array.range() 值分配
</font><font style="vertical-align: inherit;">给</font><font style="vertical-align: inherit;">和
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;">变量</font></a><em><font style="vertical-align: inherit;">。</font></em></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.min"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_array.range"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
局部</font></font><code dir="auto">minValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">范围</font></font><code dir="auto">rangeValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内</font><font style="vertical-align: inherit;">
，它在迭代过程中</font><em><font style="vertical-align: inherit;">引用</font></em><font style="vertical-align: inherit;">变量，而不是重复调用这些</font><font style="vertical-align: inherit;">
函数：</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for...in"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><code dir="auto">array.*()</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="3fp"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Loop-invariant&nbsp;code&nbsp;motion&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Returns&nbsp;a&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;`this`&nbsp;array.</span></span><br><span><span class="mtk15">featureScale</span><span class="mtk13">(</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;()</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">minValue</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.min</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">rangeValue</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.range</span><span class="mtk13">(</span><span class="mtk33">this</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">in</span><span class="mtk1">&nbsp;</span><span class="mtk33">this</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">((</span><span class="mtk33">item</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">minValue</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">rangeValue</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;containing&nbsp;the&nbsp;most&nbsp;recent&nbsp;100&nbsp;`close`&nbsp;p</span><span class="mtk9">rices.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">prices</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;(</span><span class="mtk12">100</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Queue&nbsp;the&nbsp;`close`&nbsp;through&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk33">prices</span><span class="mtk1">.</span><span class="mtk15">pop</span><span class="mtk13">()</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;feature&nbsp;scaled&nbsp;version&nbsp;of&nbsp;the&nbsp;`prices`&nbsp;array.</span></span><br><span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">float</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">featureScale</span><span class="mtk13">(</span><span class="mtk33">prices</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//&nbsp;Plot&nbsp;the&nbsp;difference&nbsp;between&nbsp;the&nbsp;first&nbsp;element&nbsp;a</span><span class="mtk9">nd&nbsp;the&nbsp;average&nbsp;value&nbsp;in&nbsp;the&nbsp;`rescaled`&nbsp;array.</span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">first</span><span class="mtk13">()</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">rescaled</span><span class="mtk1">.</span><span class="mtk15">avg</span><span class="mtk13">())</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从脚本的
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中我们可以看出，将</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不变</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算移到循环之外可以显著提高性能。这次，脚本仅用 289.3 毫秒就完成了执行：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Optimizing-loops-Loop-invariant-code-motion-2.9LhBcnjw_Zn7pRo.webp" alt="图像" width="1072" height="438" loading="lazy" decoding="async"></p>
<h3 id="minimizing-historical-buffer-calculations" class="md-heading"><a href="#minimizing-historical-buffer-calculations"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小化历史缓冲区</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计算</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine 脚本为其输出所依赖的所有变量和函数调用创建</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历史缓冲区。每个缓冲区都包含有关脚本可以使用历史引用运算符</font></font></em><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#op_%5B%5D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问的历史值范围的信息
</font><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">脚本通过分析</font><font style="vertical-align: inherit;">数据集中</font><strong><font style="vertical-align: inherit;">前 244 个柱期间执行的历史引用，</font></strong></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">确定所有变量和函数调用所需的缓冲区大小。当脚本仅</font><em><font style="vertical-align: inherit;">在</font></em><font style="vertical-align: inherit;">这些初始柱之后引用计算值的历史记录时，它将在之前的柱中重复重新</font><strong><font style="vertical-align: inherit;">启动</font></strong><font style="vertical-align: inherit;">执行，并使用连续更大的历史缓冲区，直到确定合适的大小或引发运行时错误。在某些情况下，这些重复执行可能会显著增加脚本的运行时间。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当脚本</font><font style="vertical-align: inherit;">在数据集中
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过度</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行以计算历史缓冲区时，提高其性能的一种有效方法是使用
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;">max_bars_back()函数</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定义合适的缓冲区大小
。明确声明适当的缓冲区大小后，脚本无需在过去的数据中重新执行以确定大小。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，下面的脚本使用
</font></font><a href="/pine-script-docs/concepts/lines-and-boxes#polylines"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">折线</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
绘制一个基本直方图，表示
</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">500 个条形图上计算值的分布。在</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_barstate.islast"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后一个可用条形图</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上，脚本使用
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_for"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环回顾计算</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系列的历史值并确定
</font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_polyline"><font style="vertical-align: inherit;">折线</font></a><font style="vertical-align: inherit;">绘制使用的
</font></font><a href="/pine-script-docs/language/type-system#chart-points"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图表点</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。它还</font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;">绘制了</font></a><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">以验证它执行的条形图数量：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#type_polyline"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/concepts/plots"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code dir="auto">bar_index + 1</code><font style="vertical-align: inherit;"></font></p>
<div class="pine-colorizer not-content colorized" data-id="7g2"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;historical&nbsp;buffer&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;polyline&nbsp;with&nbsp;points&nbsp;that&nbsp;form&nbsp;a&nbsp;histogram&nbsp;of&nbsp;`</span><span class="mtk9">source`&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">polyline</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;difference&nbsp;Q3&nbsp;of&nbsp;`high`&nbsp;prices&nbsp;and&nbsp;Q1&nbsp;of&nbsp;`low</span><span class="mtk9">`&nbsp;prices&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">high</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">75</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">low</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;highest&nbsp;and&nbsp;lowest&nbsp;prices,&nbsp;and&nbsp;th</span><span class="mtk9">e&nbsp;total&nbsp;price&nbsp;range,&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.lowest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;source&nbsp;series&nbsp;for&nbsp;histogram&nbsp;calculation.&nbsp;Its&nbsp;</span><span class="mtk9">value&nbsp;is&nbsp;the&nbsp;midpoint&nbsp;between&nbsp;the&nbsp;`open`&nbsp;and&nbsp;`clos</span><span class="mtk9">e`.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk11">open</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">polyline.delete</span><span class="mtk13">(</span><span class="mtk33">display</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;histogram&nbsp;bins&nbsp;and&nbsp;thei</span><span class="mtk9">r&nbsp;size.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk33">bins</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">(</span><span class="mtk16">math.round</span><span class="mtk13">(</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">bins</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;chart&nbsp;points&nbsp;for&nbsp;the&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;(</span><span class="mtk33">bins</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;build&nbsp;the&nbsp;histogram.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">499</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;histogram&nbsp;bin&nbsp;number.&nbsp;Uses&nbsp;past&nbsp;values&nbsp;of&nbsp;the</span><span class="mtk9">&nbsp;`source`&nbsp;for&nbsp;its&nbsp;calculation.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;script&nbsp;must&nbsp;execute&nbsp;across&nbsp;all&nbsp;pre</span><span class="mtk9">vious&nbsp;bars&nbsp;AGAIN&nbsp;to&nbsp;determine&nbsp;the&nbsp;historical&nbsp;buffe</span><span class="mtk9">r&nbsp;for&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`source`,&nbsp;as&nbsp;initial&nbsp;references&nbsp;to&nbsp;the</span><span class="mtk9">&nbsp;calculated&nbsp;series&nbsp;occur&nbsp;AFTER&nbsp;the&nbsp;first&nbsp;244&nbsp;bars.</span><span class="mtk9">&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">((</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk1">&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">set</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.from_index</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;final&nbsp;points&nbsp;to&nbsp;the&nbsp;`points`&nbsp;array&nbsp;and&nbsp;draw</span><span class="mtk9">&nbsp;the&nbsp;new&nbsp;`display`&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">highest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">polyline.new</span><span class="mtk13">(</span><span class="mtk33">points</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">closed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Number&nbsp;of&nbsp;bars"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">display.data_window</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于脚本</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引用</font><em><font style="vertical-align: inherit;">最后一条柱状图</font></em></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的过去值</font><font style="vertical-align: inherit;">，因此它不会</font><strong><font style="vertical-align: inherit;">在</font></strong><font style="vertical-align: inherit;">较大的数据集的前 244 条柱状图内为该系列构建合适的历史缓冲区。因此，它将在所有历史柱状图上</font><strong><font style="vertical-align: inherit;">重新执行</font></strong><font style="vertical-align: inherit;">以确定适当的缓冲区大小。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从脚本在 20,320 个柱状图上运行后的分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中可以看出
，</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全局</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码执行次数
</font><font style="vertical-align: inherit;">为 162,560 次，是图表柱状图数量的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">八倍</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。换句话说，脚本必须</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历史执行</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">七次</font></font></strong><font style="vertical-align: inherit;"></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">才能确定本例中</font><font style="vertical-align: inherit;">适合该系列的缓冲区：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-historical-buffer-calculations-1.Cyx3FoQJ_Z1xcPM1.webp" alt="图像" width="1318" height="532" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此脚本将仅引用最后一个历史条和所有实时条上的</font><font style="vertical-align: inherit;">最近 500 个值。因此，我们可以通过使用</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;">max_bars_back()定义 500 条引用长度来帮助它建立正确的缓冲区</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而无需</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新执行
</font><font style="vertical-align: inherit;">。</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在以下脚本版本中，我们在变量声明后添加了</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_bars_back(source, 500)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
，以明确指定脚本</font></font><code dir="auto">source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在执行过程中将访问最多 500 个历史值：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="57y"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Minimizing&nbsp;historical&nbsp;buffer&nbsp;calculations&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">overlay</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;A&nbsp;polyline&nbsp;with&nbsp;points&nbsp;that&nbsp;form&nbsp;a&nbsp;histogram&nbsp;of&nbsp;`</span><span class="mtk9">source`&nbsp;values.</span></span><br><span><span class="mtk18">var</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">polyline</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;difference&nbsp;Q3&nbsp;of&nbsp;`high`&nbsp;prices&nbsp;and&nbsp;Q1&nbsp;of&nbsp;`low</span><span class="mtk9">`&nbsp;prices&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">high</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">75</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.percentile_nearest_rank</span><span class="mtk13">(</span><span class="mtk11">low</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">25</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;highest&nbsp;and&nbsp;lowest&nbsp;prices,&nbsp;and&nbsp;th</span><span class="mtk9">e&nbsp;total&nbsp;price&nbsp;range,&nbsp;over&nbsp;500&nbsp;bars.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.highest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">ta.lowest</span><span class="mtk13">(</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">highest</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;source&nbsp;series&nbsp;for&nbsp;histogram&nbsp;calculation.&nbsp;Its&nbsp;</span><span class="mtk9">value&nbsp;is&nbsp;the&nbsp;midpoint&nbsp;between&nbsp;the&nbsp;`open`&nbsp;and&nbsp;`clos</span><span class="mtk9">e`.</span></span><br><span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">source</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.avg</span><span class="mtk13">(</span><span class="mtk11">open</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">close</span><span class="mtk13">)</span></span><br><span><span class="mtk9">//&nbsp;Explicitly&nbsp;define&nbsp;a&nbsp;500-bar&nbsp;historical&nbsp;buffer&nbsp;f</span><span class="mtk9">or&nbsp;the&nbsp;`source`&nbsp;to&nbsp;prevent&nbsp;recalculation.</span></span><br><span><span class="mtk16">max_bars_back</span><span class="mtk13">(</span><span class="mtk33">source</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">500</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk11">barstate.islast</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk16">polyline.delete</span><span class="mtk13">(</span><span class="mtk33">display</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Calculate&nbsp;the&nbsp;number&nbsp;of&nbsp;histogram&nbsp;bins&nbsp;and&nbsp;thei</span><span class="mtk9">r&nbsp;size.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;&nbsp;&nbsp;</span><span class="mtk33">bins</span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">(</span><span class="mtk16">math.round</span><span class="mtk13">(</span><span class="mtk12">5</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">innerRange</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">float</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">totalRange</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">bins</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;An&nbsp;array&nbsp;of&nbsp;chart&nbsp;points&nbsp;for&nbsp;the&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">array</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">array.new</span><span class="mtk13">&lt;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk13">&gt;(</span><span class="mtk33">bins</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.new</span><span class="mtk13">(</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk11">na</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Loop&nbsp;to&nbsp;build&nbsp;the&nbsp;histogram.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">for</span><span class="mtk1">&nbsp;</span><span class="mtk33">i</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">to</span><span class="mtk1">&nbsp;</span><span class="mtk12">499</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;histogram&nbsp;bin&nbsp;number.&nbsp;Uses&nbsp;past&nbsp;values&nbsp;of&nbsp;the</span><span class="mtk9">&nbsp;`source`&nbsp;for&nbsp;its&nbsp;calculation.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Since&nbsp;the&nbsp;`source`&nbsp;now&nbsp;has&nbsp;an&nbsp;appropri</span><span class="mtk9">ate&nbsp;predefined&nbsp;buffer,&nbsp;the&nbsp;script&nbsp;no&nbsp;longer&nbsp;needs&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;recalculate&nbsp;across&nbsp;previous&nbsp;bars&nbsp;to</span><span class="mtk9">&nbsp;determine&nbsp;the&nbsp;referencing&nbsp;length.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">int</span><span class="mtk13">((</span><span class="mtk33">source</span><span class="mtk13">[</span><span class="mtk33">i</span><span class="mtk13">]</span><span class="mtk1">&nbsp;</span><span class="mtk18">-</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">/</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">chart.point</span><span class="mtk1">&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">get</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk16">na</span><span class="mtk13">(</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">set</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">chart.point.from_index</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk13">(</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">0.5</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">*</span><span class="mtk1">&nbsp;</span><span class="mtk33">binSize</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">continue</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">currentPoint</span><span class="mtk1">.</span><span class="mtk33">index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Add&nbsp;final&nbsp;points&nbsp;to&nbsp;the&nbsp;`points`&nbsp;array&nbsp;and&nbsp;draw</span><span class="mtk9">&nbsp;the&nbsp;new&nbsp;`display`&nbsp;polyline.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">unshift</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">lowest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">points</span><span class="mtk1">.</span><span class="mtk15">push</span><span class="mtk13">(</span><span class="mtk16">chart.point.now</span><span class="mtk13">(</span><span class="mtk33">highest</span><span class="mtk13">))</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">:=</span><span class="mtk1">&nbsp;</span><span class="mtk16">polyline.new</span><span class="mtk13">(</span><span class="mtk33">points</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">closed</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">true</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk11">bar_index</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"Number&nbsp;of&nbsp;bars"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">display</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk11">display.data_window</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">经过这一更改，我们的脚本不再需要在所有历史数据中重新执行来确定缓冲区大小。正如我们在
下面的</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#interpreting-profiled-results"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中看到的那样，全局代码执行的数量现在与图表条的数量一致，并且脚本完成所有历史执行所需的时间大大减少：</font></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Optimization-Minimizing-historical-buffer-calculations-2.DPrfVLfJ_Z1XIu4W.webp" alt="图像" width="1318" height="532" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此脚本仅需要最近 501 个历史条形图来计算其绘图输出。在这种情况下，优化资源使用的另一种方法是将其包含</font></font><code dir="auto">calc_bars_count = 501</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_indicator"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicator()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
函数中，该函数通过将脚本可以计算的历史数据限制为 501 个条形图来减少不必要的脚本执行。</font></font></li>
</ul>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span></p><p><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_max_bars_back"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当使用max_bars_back()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确定义有问题的历史参考的缓冲区大小时
</font><font style="vertical-align: inherit;">，必须确保脚本在以后的执行中</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用比指定更多的数据，因为如果用户指定的大小不足，脚本仍会在历史条上重新执行并尝试计算缓冲区。</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确定义缓冲区大小时要考虑的另一个问题是缓冲区越大，</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内存成本</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就越大。因此，程序员应尽量将显式缓冲区长度限制为</font><font style="vertical-align: inherit;">脚本将引用的最大历史值数量，而</font><strong><font style="vertical-align: inherit;">不是更多。例如，当脚本</font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要 500 个历史值时，定义 5000 条缓冲区将导致不必要的内存浪费。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font></p><p></p></div></aside>
<h2 id="tips" class="md-heading"><a href="#tips"> <span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提示</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h2>
<h3 id="working-around-profiler-overhead" class="md-heading"><a href="#working-around-profiler-overhead"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决 Profiler</font></font><span class="fancy-wrap"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开销问题</font></font><span class="icon icon-link" aria-hidden="true"><svg width="28" height="28" viewBox="0 0 28 28"><g fill="currentColor" clip-path="url(#a)"><path d="M14.908 5.558a5.326 5.326 0 1 1 7.533 7.533l-3.236 3.236-1.061-1.061 3.236-3.236a3.826 3.826 0 1 0-5.411-5.411l-3.236 3.236-1.06-1.06 3.235-3.237ZM5.56 14.907a5.326 5.326 0 0 0 7.532 7.533l3.236-3.236-1.061-1.061-3.236 3.236a3.826 3.826 0 1 1-5.411-5.411l3.236-3.236-1.061-1.06-3.236 3.235Z"></path><path d="m16.346 10.592-5.753 5.753 1.061 1.06 5.753-5.752-1.06-1.06Z"></path></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h28v28H0z"></path></clipPath></defs></svg></span></span></a></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Profiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须执行</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">额外的计算来收集性能数据（如</font></font></em><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#alook-into-the-profilers-inner-workings"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本节</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所述），因此
在分析时</font><font style="vertical-align: inherit;">执行脚本所需的时间</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会增加</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑到 Profiler 的开销，大多数脚本都能按预期运行。但是，当复杂脚本的运行时间接近计划
</font></font><a href="https://www.tradingview.com/support/solutions/43000579793/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的限制</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时，
</font><font style="vertical-align: inherit;">在其上使用</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profiler可能会导致其运行时间</font></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">超出</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">限制。这种情况表明脚本可能需要
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#optimization"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化，但如果无法</font></font></a><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#profiling-ascript"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析代码，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就很难知道从哪里开始
</font><font style="vertical-align: inherit;">。在这种情况下，最有效的解决方法是减少脚本必须执行的条形图数量。用户可以通过以下任何一种方式实现此减少：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择历史记录中数据点较少的数据集，例如较高的时间范围或数据有限的符号</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用条件逻辑将代码执行限制在特定时间或条形范围内</font></font></li>
<li><font style="vertical-align: inherit;"></font><code dir="auto">calc_bars_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在脚本的声明语句中</font><font style="vertical-align: inherit;">包含一个参数，以指定可以使用多少个最近的历史条形图</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少数据点的数量在大多数情况下是有效的，因为它直接减少了脚本必须执行的次数，通常会导致累积运行时间减少。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为演示，此脚本包含一个</font></font><code dir="auto">gcd()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数，该函数使用
</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算法来计算两个整数的</font></font><a href="https://en.wikipedia.org/wiki/Greatest_common_divisor" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大公约数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。该函数使用两个数字的最小绝对值初始化其。然后，它在</font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_while"><font style="vertical-align: inherit;">while</font></a><font style="vertical-align: inherit;">循环中将
</font></font><code dir="auto">result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值减一，
</font><font style="vertical-align: inherit;">
直到它可以将两个数字相除而无余数。此结构要求循环将迭代最多</font><em><font style="vertical-align: inherit;">N</font></em><font style="vertical-align: inherit;">次，其中</font><em><font style="vertical-align: inherit;">N</font></em><font style="vertical-align: inherit;">是两个参数中最小的那个。</font></font><code dir="auto">result</code><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_while"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此示例中，脚本绘制了 的值
</font></font><code dir="auto">gcd(10000, 10000 + bar_index)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在本例中，两个参数中最小的一个始终为 10,000，这意味着
函数内的</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#kw_while"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循环每次执行脚本将需要最多 10,000 次迭代，具体取决于
</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#var_bar_index"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bar_index</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值：</font></font></p>
<div class="pine-colorizer not-content colorized" data-id="5pv"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Script&nbsp;takes&nbsp;too&nbsp;long&nbsp;while&nbsp;profiling&nbsp;demo"</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;greatest&nbsp;common&nbsp;divisor&nbsp;of&nbsp;`a`&nbsp;and</span><span class="mtk9">&nbsp;`b`&nbsp;using&nbsp;a&nbsp;naive&nbsp;algorithm.</span></span><br><span><span class="mtk15">gcd</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;greatest&nbsp;common&nbsp;divisor.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk16">math.min</span><span class="mtk13">(</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">a</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">b</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Reduce&nbsp;the&nbsp;`result`&nbsp;by&nbsp;1&nbsp;until&nbsp;it&nbsp;divides&nbsp;`a`&nbsp;a</span><span class="mtk9">nd&nbsp;`b`&nbsp;without&nbsp;remainders.&nbsp;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">while</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">break</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">-=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;`result`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">gcd</span><span class="mtk13">(</span><span class="mtk12">10000</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"GCD"</span><span class="mtk13">)</span></span><br></code></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我们将脚本添加到图表中时，它需要一段时间才能在图表数据中执行，但不会引发错误。但是，在</font><font style="vertical-align: inherit;">
启用
</font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;">Profiler</font></a></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，脚本会引发运行时错误，指出它超出了 Premium 计划的</font><a href="https://www.tradingview.com/support/solutions/43000579793/"><font style="vertical-align: inherit;">运行时间限制</font></a><font style="vertical-align: inherit;">（40 秒）：</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://www.tradingview.com/support/solutions/43000579793/"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Tips-Working-around-profiler-overhead-The-script-takes-too-long-to-execute-1.ChWuvP-N_1heDWT.webp" alt="图像" width="1072" height="590" loading="lazy" decoding="async"></p>
<p><font style="vertical-align: inherit;"></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们当前的图表有超过 20,000 个历史条形图，对于脚本来说，在Profiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处于活动状态时，在规定的时间内处理这些条形图可能太多了
</font><font style="vertical-align: inherit;">。在这种情况下，我们可以尝试限制历史执行次数来解决此问题。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下面，我们加入了</font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_indicator"><font style="vertical-align: inherit;">indicator()</font></a></font><code dir="auto">calc_bars_count = 10000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数
</font><font style="vertical-align: inherit;">
，该函数将脚本的可用历史记录限制为最近的 10,000 个历史条。限制脚本的历史执行后，它在分析时不再超出 Premium 计划的限制，因此我们现在可以检查其性能结果：</font></font><a href="https://www.tradingview.com/pine-script-reference/v5/#fun_indicator"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></p>
<p><img src="/pine-script-docs/_astro/Profiling-and-optimization-Tips-Working-around-profiler-overhead-The-script-takes-too-long-to-execute-2.DN-scZLp_Z1HYEfF.webp" alt="图像" width="1072" height="590" loading="lazy" decoding="async"></p>
<div class="pine-colorizer not-content colorized" data-id="ei"><div class="pine-colorizer__header"><a class="pine-colorizer__title" href="https://tradingview.com/pine-script-docs/en/v5/Introduction.html" target="_blank" rel="noopener"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pine Script™</font></font></span></a><button class="pine-colorizer__copy-btn"><div class="pine-colorizer__tooltip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已复制</font></font></div></button></div><code class="monaco-editor-tv-pine-light"><span><span class="mtk9">//</span><span class="mtk9 mtkb">@version=</span><span class="mtk9">5</span></span><br><span><span class="mtk16">indicator</span><span class="mtk13">(</span><span class="mtk29">"Script&nbsp;takes&nbsp;too&nbsp;long&nbsp;while&nbsp;profiling&nbsp;demo"</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk33">calc_bars_count</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk13">)</span></span><br><span><span></span></span><br><span><span class="mtk9">//</span><span class="mtk9 mtkb">@function</span><span class="mtk9">&nbsp;Calculates&nbsp;the&nbsp;greatest&nbsp;common&nbsp;divisor&nbsp;of&nbsp;`a`&nbsp;and</span><span class="mtk9">&nbsp;`b`&nbsp;using&nbsp;a&nbsp;naive&nbsp;algorithm.</span></span><br><span><span class="mtk15">gcd</span><span class="mtk13">(</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk13">)</span><span class="mtk1">&nbsp;</span><span class="mtk18">=&gt;</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//</span><span class="mtk9 mtkb">@variable</span><span class="mtk9">&nbsp;The&nbsp;greatest&nbsp;common&nbsp;divisor.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18 mtkb">int</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">=</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.max</span><span class="mtk13">(</span><span class="mtk16">math.min</span><span class="mtk13">(</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">a</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk16">math.abs</span><span class="mtk13">(</span><span class="mtk33">b</span><span class="mtk13">))</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span><span class="mtk13">)</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Reduce&nbsp;the&nbsp;`result`&nbsp;by&nbsp;1&nbsp;until&nbsp;it&nbsp;divides&nbsp;`a`&nbsp;a</span><span class="mtk9">nd&nbsp;`b`&nbsp;without&nbsp;remainders.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">while</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">&gt;</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">if</span><span class="mtk1">&nbsp;</span><span class="mtk33">a</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span><span class="mtk1">&nbsp;</span><span class="mtk18">and</span><span class="mtk1">&nbsp;</span><span class="mtk33">b</span><span class="mtk1">&nbsp;</span><span class="mtk18">%</span><span class="mtk1">&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">==</span><span class="mtk1">&nbsp;</span><span class="mtk12">0</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk18">break</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span><span class="mtk1">&nbsp;</span><span class="mtk18">-=</span><span class="mtk1">&nbsp;</span><span class="mtk12">1</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk9">//&nbsp;Return&nbsp;the&nbsp;`result`.</span></span><br><span><span class="mtk1">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="mtk33">result</span></span><br><span><span></span></span><br><span><span class="mtk16">plot</span><span class="mtk13">(</span><span class="mtk33">gcd</span><span class="mtk13">(</span><span class="mtk12">10000</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk12">10000</span><span class="mtk1">&nbsp;</span><span class="mtk18">+</span><span class="mtk1">&nbsp;</span><span class="mtk11">bar_index</span><span class="mtk13">)</span><span class="mtk18">,</span><span class="mtk1">&nbsp;</span><span class="mtk29">"GCD"</span><span class="mtk13">)</span></span><br></code></div>
<aside aria-label="注意！" class="tv-informer not-content" style="--informer-header-color:#FF9800;--informer-back-color-light:#FFF3E0;--informer-back-color-dark:#33261A"><div class="tv-informer-icon"><svg viewBox="0 0 18 18" width="18" height="18"><path fill-rule="evenodd" d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16ZM9 4c-.79 0-1.38.7-1.25 1.48l.67 4.03a.59.59 0 0 0 1.16 0l.67-4.03A1.27 1.27 0 0 0 9 4Zm0 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z" fill="currentColor"></path></svg></div><div class="tv-informer-content"><p><span class="tv-informer-header"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此过程可能需要反复试验，因为确定计算量大的脚本在超时前可以处理的执行次数并不一定简单。如果启用 Profiler 后脚本执行时间过长，
</font></font><a href="/pine-script-docs/writing/profiling-and-optimization#pine-profiler"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尝试使用不同的方式来限制其执行，直到您可以成功对其进行分析。</font></font></p></div></aside>      </div> <div class="pagination-buttons not-content" data-astro-cid-xgirumru=""> <a href="/pine-script-docs/writing/debugging" class="pagination-card" data-pagefind-ignore="" data-astro-cid-assl6cvf=""> <p data-astro-cid-assl6cvf=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前的</font></font></p> <h4 class="pagination-card-header" data-astro-cid-assl6cvf=""> <svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-assl6cvf="" data-icon="theme/arrow-back">  <use xlink:href="#ai:local:theme/arrow-back"></use>  </svg><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试  </font></font></h4> </a>  <a href="/pine-script-docs/writing/publishing" class="pagination-card" data-pagefind-ignore="" data-astro-cid-assl6cvf=""> <p data-astro-cid-assl6cvf=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个</font></font></p> <h4 class="pagination-card-header" data-astro-cid-assl6cvf=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  发布脚本</font></font><svg width="28" height="28" viewBox="0 0 28 28" data-astro-cid-assl6cvf="" data-icon="theme/arrow">  <symbol id="ai:local:theme/arrow"><path fill="none" stroke="var(--arrow-fill-color, #131722)" d="m11 8 6 6-6 6"></path></symbol><use xlink:href="#ai:local:theme/arrow"></use>  </svg> </h4> </a>  </div>  </main>   <div id="toc" data-pagefind-ignore="" data-astro-cid-oor6cujd=""><aside class="document-toc-container ml-4 w-48" data-astro-cid-oor6cujd=""><section data-astro-cid-oor6cujd=""><header data-astro-cid-oor6cujd=""><h2 class="toc-header" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本页</font></font></h2></header><ul class="" id="toc-entries" data-astro-cid-oor6cujd=""><a href="#profiling-and-optimization" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-2" data-current="" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析和优化</font></font></li></a><a href="#introduction" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></li></a><a href="#pine-profiler" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">松木剖面仪</font></font></li></a><a href="#profiling-a-script" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析脚本</font></font></li></a><a href="#interpreting-profiled-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解释分析结果</font></font></li></a><a href="#single-line-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单行结果</font></font></li></a><a href="#code-block-results" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码块结果</font></font></li></a><a href="#user-defined-function-calls" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户定义函数调用</font></font></li></a><a href="#when-requesting-other-contexts" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请求其他上下文时</font></font></li></a><a href="#insignificant-unused-and-redundant-code" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不重要、未使用和冗余的代码</font></font></li></a><a href="#a-look-into-the-profilers-inner-workings" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了解 Profiler 的内部工作原理</font></font></li></a><a href="#profiling-across-configurations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">跨配置分析</font></font></li></a><a href="#repetitive-profiling" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重复分析</font></font></li></a><a href="#optimization" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></li></a><a href="#using-built-ins" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用内置函数</font></font></li></a><a href="#reducing-repetition" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少重复</font></font></li></a><a href="#minimizing-request-calls" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尽量减少 `request.*()` 调用</font></font></li></a><a href="#avoiding-redrawing" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">避免重绘</font></font></li></a><a href="#reducing-drawing-updates" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少图纸更新</font></font></li></a><a href="#storing-calculated-values" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储计算值</font></font></li></a><a href="#eliminating-loops" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消除环路</font></font></li></a><a href="#optimizing-loops" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化循环</font></font></li></a><a href="#reducing-loop-calculations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">减少循环计算</font></font></li></a><a href="#loop-invariant-code-motion" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-5" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环不变代码移动</font></font></li></a><a href="#minimizing-historical-buffer-calculations" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小化历史缓冲区计算</font></font></li></a><a href="#tips" class="document-toc-link" data-astro-cid-oor6cujd=""><li class="l-3" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提示</font></font></li></a><a href="#working-around-profiler-overhead" class="document-toc-link" data-astro-cid-oor6cujd="" aria-current="true"><li class="l-4" data-astro-cid-oor6cujd=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决 Profiler 开销问题</font></font></li></a></ul><a class="back-top" href="#top" data-astro-cid-oor6cujd=""><svg width="16" height="16" viewBox="0 0 16 16" data-astro-cid-oor6cujd="" data-icon="theme/back-top">  <symbol id="ai:local:theme/back-top"><path fill="currentColor" fill-rule="evenodd" d="M6.25 12.5A2.75 2.75 0 0 0 9 9.75V4.56L6.78 6.78a.75.75 0 0 1-1.06-1.06l3.5-3.5a.75.75 0 0 1 1.06 0l3.5 3.5a.75.75 0 0 1-1.06 1.06L10.5 4.56v5.19a4.25 4.25 0 0 1-8.5 0v-1a.75.75 0 0 1 1.5 0v1a2.75 2.75 0 0 0 2.75 2.75Z" clip-rule="evenodd"></path></symbol><use xlink:href="#ai:local:theme/back-top"></use>  </svg><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回到顶部
</font></font></a></section></aside></div> </main> </div>            <script data-astro-rerun="" src="/pine-script-docs/static/pine-highlighter-v06.js" data-astro-exec=""></script><div id="goog-gt-tt" class="VIpgJd-yAWNEb-L7lbkb skiptranslate" style="border-radius: 12px; margin: 0 0 0 -23px; padding: 0; font-family: 'Google Sans', Arial, sans-serif;" data-id=""><div id="goog-gt-vt" class="VIpgJd-yAWNEb-hvhgNd"><div class=" VIpgJd-yAWNEb-hvhgNd-l4eHX-i3jM8c"><img src="https://fonts.gstatic.com/s/i/productlogos/translate/v14/24px.svg" width="24" height="24" alt=""></div><div class=" VIpgJd-yAWNEb-hvhgNd-k77Iif-i3jM8c"><div class="VIpgJd-yAWNEb-hvhgNd-IuizWc" dir="ltr">Original text</div><div id="goog-gt-original-text" class="VIpgJd-yAWNEb-nVMfcd-fmcmS VIpgJd-yAWNEb-hvhgNd-axAV1"></div></div><div class="VIpgJd-yAWNEb-hvhgNd-N7Eqid ltr"><div class="VIpgJd-yAWNEb-hvhgNd-N7Eqid-B7I4Od ltr" dir="ltr"><div class="VIpgJd-yAWNEb-hvhgNd-UTujCb">Rate this translation</div><div class="VIpgJd-yAWNEb-hvhgNd-eO9mKe">Your feedback will be used to help improve Google Translate</div></div><div class="VIpgJd-yAWNEb-hvhgNd-xgov5 ltr"><button id="goog-gt-thumbUpButton" type="button" class="VIpgJd-yAWNEb-hvhgNd-bgm6sf" title="Good translation" aria-label="Good translation" aria-pressed="false"><span id="goog-gt-thumbUpIcon"><svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class="VIpgJd-yAWNEb-hvhgNd-THI6Vb NMm5M"><path d="M21 7h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 0S7.08 6.85 7 7H2v13h16c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73V9c0-1.1-.9-2-2-2zM7 18H4V9h3v9zm14-7l-3 7H9V8l4.34-4.34L12 9h9v2z"></path></svg></span><span id="goog-gt-thumbUpIconFilled"><svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class="VIpgJd-yAWNEb-hvhgNd-THI6Vb NMm5M"><path d="M21 7h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 0S7.08 6.85 7 7v13h11c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73V9c0-1.1-.9-2-2-2zM5 7H1v13h4V7z"></path></svg></span></button><button id="goog-gt-thumbDownButton" type="button" class="VIpgJd-yAWNEb-hvhgNd-bgm6sf" title="Poor translation" aria-label="Poor translation" aria-pressed="false"><span id="goog-gt-thumbDownIcon"><svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class="VIpgJd-yAWNEb-hvhgNd-THI6Vb NMm5M"><path d="M3 17h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 24s7.09-6.85 7.17-7h5V4H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2zM17 6h3v9h-3V6zM3 13l3-7h9v10l-4.34 4.34L12 15H3v-2z"></path></svg></span><span id="goog-gt-thumbDownIconFilled"><svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class="VIpgJd-yAWNEb-hvhgNd-THI6Vb NMm5M"><path d="M3 17h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 24s7.09-6.85 7.17-7V4H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2zm16 0h4V4h-4v13z"></path></svg></span></button></div></div><div id="goog-gt-votingHiddenPane" class="VIpgJd-yAWNEb-hvhgNd-aXYTce"><form id="goog-gt-votingForm" action="//translate.googleapis.com/translate_voting?client=te_lib" method="post" target="votingFrame" class="VIpgJd-yAWNEb-hvhgNd-aXYTce"><input type="text" name="sl" id="goog-gt-votingInputSrcLang"><input type="text" name="tl" id="goog-gt-votingInputTrgLang"><input type="text" name="query" id="goog-gt-votingInputSrcText"><input type="text" name="gtrans" id="goog-gt-votingInputTrgText"><input type="text" name="vote" id="goog-gt-votingInputVote"></form><iframe name="votingFrame" frameborder="0"></iframe></div></div></div> </body></html>